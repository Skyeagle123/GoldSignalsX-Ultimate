<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>GoldSignalsX â€¢ Ultimate</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root {
      --bg: #050712;
      --bg-elevated: #0c0f1f;
      --bg-soft: #16192b;
      --accent: #ffb347;
      --accent-soft: #3b2a15;
      --accent-strong: #ff8c3c;
      --danger: #f44747;
      --text: #f7f7ff;
      --muted: #9ca3af;
      --border-subtle: #202338;
      --green: #4ade80;
      --red: #f87171;
      --purple: #a855f7;
      --blue: #60a5fa;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #101322 0, #050712 55%);
      color: var(--text);
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 12px 48px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    .subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.1);
      color: var(--green);
      font-size: 12px;
      border: 1px solid rgba(34, 197, 94, 0.35);
      white-space: nowrap;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--green);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .card {
      background: radial-gradient(circle at top left, #1d2238 0, #050712 60%);
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      padding: 14px 14px 16px;
      margin-bottom: 14px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .card-caption {
      font-size: 11px;
      color: var(--muted);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 0.9fr);
      gap: 10px;
    }

    @media (max-width: 768px) {
      .controls-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .input,
    select {
      width: 100%;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      outline: none;
    }

    .input::placeholder {
      color: #4b5563;
    }

    select {
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 14px) 12px, calc(100% - 9px) 12px;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-inline-end: 28px;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 9px 13px;
      background: rgba(15, 23, 42, 0.9);
      font-size: 12px;
      white-space: nowrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-family: inherit;
      padding: 11px 18px;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background 0.1s ease;
    }

    .btn-primary {
      background: radial-gradient(circle at top, var(--accent) 0, #d97706 55%);
      color: #111827;
      box-shadow: 0 12px 30px rgba(251, 191, 36, 0.25);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 35px rgba(251, 191, 36, 0.35);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:hover {
      background: rgba(30, 64, 175, 0.9);
      border-color: rgba(59, 130, 246, 0.7);
    }

    .btn-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      cursor: pointer;
      font-size: 16px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
    }

    .checkbox-row input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: var(--accent-strong);
      cursor: pointer;
    }

    .metrics-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 10px;
      font-size: 11px;
    }

    @media (max-width: 640px) {
      .metrics-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .metric-card {
      border-radius: 14px;
      padding: 8px 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border-subtle);
    }

    .metric-label {
      color: var(--muted);
      font-size: 11px;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 14px;
      font-weight: 600;
    }

    .metric-tag {
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 3px;
    }

    .chart-card {
      padding: 12px 10px 10px;
    }

    #chart {
      width: 100%;
      height: 400px;
    }

    @media (max-width: 640px) {
      #chart {
        height: 340px;
      }
    }

    .tf-badge {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .indicators-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      font-size: 11px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 9px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
    }

    .chip span {
      opacity: 0.7;
      margin-inline-start: 3px;
    }

    .smart-card {
      border-radius: 16px;
      padding: 10px 12px;
      margin-top: 10px;
      background: radial-gradient(circle at right, #3b2a15 0, #120b06 55%);
      border: 1px solid rgba(251, 191, 36, 0.4);
      color: #fefce8;
      position: relative;
      overflow: hidden;
    }

    .smart-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(22, 163, 74, 0.18);
      border: 1px solid rgba(22, 163, 74, 0.6);
      font-size: 11px;
      margin-bottom: 4px;
    }

    .smart-body {
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-line;
    }

    .smart-body strong {
      font-weight: 700;
    }

    .smart-badge {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 4px;
      white-space: pre-line;
    }

    .smart-dot {
      position: absolute;
      inset-inline-end: -12px;
      bottom: -18px;
      width: 80px;
      height: 80px;
      border-radius: 999px;
      border: 8px solid rgba(251, 191, 36, 0.22);
      opacity: 0.8;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØµÙŠØ­Ø© (1..6) */
    .smart-rules {
      margin: 8px 0 4px;
      padding-inline-start: 18px;
      font-size: 11px;
      line-height: 1.7;
    }

    .smart-rules li {
      margin-bottom: 2px;
    }

    footer {
      margin-top: 18px;
      font-size: 11px;
      color: var(--muted);
      opacity: 0.75;
      text-align: center;
    }

    .badge-small {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.45);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <div class="title">GoldSignalsX â€¢ Ultimate</div>
        <div class="subtitle">
          Ø³Ø¹Ø± Ø­ÙŠ + Ø´Ù…ÙˆØ¹ + Ù…Ø¤Ø´Ø±Ø§Øª (EMAØŒ RSIØŒ ATRØŒ Bollinger Bands) + Ù†ØµÙŠØ­Ø© Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬
        </div>
      </div>
      <div class="status-pill">
        <span class="status-dot"></span>
        <span>Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù€ Worker</span>
      </div>
    </header>

    <!-- Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆÙˆØ±ÙƒØ± + Ø§Ù„ØªØ­ÙƒÙ… -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</div>
          <div class="card-caption">Ø§Ø®ØªØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù€ WorkerØŒ TFØŒ ÙˆØ§Ù„Ù€ Limit Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù…ÙˆØ¹.</div>
        </div>
        <button id="btnSaveUrl" class="btn-icon" title="Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­">ğŸ’¾</button>
      </div>

      <div class="controls-grid">
        <div>
          <div class="field-label">Worker URL</div>
          <input
            id="workerUrl"
            class="input"
            type="text"
            placeholder="https://goldsignalsx-worker.samer-mourtada.workers.dev"
          />
          <div class="checkbox-row">
            <input type="checkbox" id="autoCandles" checked />
            <label for="autoCandles">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù…ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ©</label>
          </div>
        </div>

        <div>
          <div class="row">
            <div style="flex:1;">
              <div class="field-label">TF</div>
              <select id="tfSelect">
                <option value="1m">1m</option>
                <option value="5m">5m</option>
                <option value="15m" selected>15m</option>
                <option value="30m">30m</option>
                <option value="60m">60m</option>
                <option value="240m">4h</option>
                <option value="1d">ÙŠÙˆÙ…</option>
              </select>
            </div>
            <div style="flex:1;">
              <div class="field-label">Limit</div>
              <input id="limitInput" type="number" min="50" max="2000" step="50" class="input" value="1200" />
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="btnFetchCandles" class="btn btn-secondary" style="flex:1;">
              ğŸ“Š Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ ÙˆØ±Ø³Ù… Ø§Ù„Ø´Ø§Ø±Øª
            </button>
            <button id="btnFetchPrice" class="btn btn-primary" style="flex:1;">
              ğŸ’² ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ
            </button>
          </div>
          <div class="checkbox-row">
            <input type="checkbox" id="autoPrice" checked />
            <label for="autoPrice">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ©</label>
          </div>
        </div>
      </div>

      <div class="metrics-row">
        <div class="metric-card">
          <div class="metric-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ Ø§Ù„Ø¢Ù†</div>
          <div class="metric-value" id="livePrice">â€”</div>
          <div class="metric-tag">
            <span>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span>
            <span id="lastPriceUpdate">â€”</span>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Ø³Ø¹Ø± Ø¢Ø®Ø± Ø´Ù…Ø¹Ø© (Ø¥ØºÙ„Ø§Ù‚)</div>
          <div class="metric-value" id="lastClose">â€”</div>
          <div class="metric-tag">
            <span>TF:</span>
            <span id="lastTf">â€”</span>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
          <div class="metric-value" id="dataStatus">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø´Ù…ÙˆØ¹...</div>
          <div class="metric-tag">
            <span id="candlesCountTag">Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù…ÙˆØ¹: â€”</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Ø§Ù„Ø´Ø§Ø±Øª + Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª -->
    <section class="card chart-card">
      <div class="tf-badge">
        <span>TF: <strong id="tfLabel">â€”</strong> Â· Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù…ÙˆØ¹: <strong id="candlesCount">â€”</strong></span>
        <span class="badge-small">EMA + RSI + ATR + Bollinger Bands</span>
      </div>
      <div id="chart"></div>

      <div class="indicators-row">
        <div class="chip" id="chipEMA">EMA(21): <span id="emaVal">â€”</span></div>
        <div class="chip" id="chipRSI">RSI(14): <span id="rsiVal">â€”</span></div>
        <div class="chip" id="chipATR">ATR(14): <span id="atrVal">â€”</span></div>
        <div class="chip" id="chipBB">
          BB Width:
          <span id="bbWidthVal">â€”</span>
        </div>
        <div class="chip">
          Ø£Ø­Ø¯Ø« Ø¥Ø´Ø§Ø±Ø©:
          <span id="lastSignal">â€”</span>
        </div>
      </div>

      <div class="smart-card" id="smartCard">
        <div class="smart-pill">
          ğŸ¤– SMART ADVICE (OnlyWhenSignal)
        </div>
        <div class="smart-body" id="smartText">
          Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ ÙˆØªØ­Ø¶ÙŠØ± Ø§Ù„Ù†ØµÙŠØ­Ø©...
        </div>
        <div class="smart-badge" id="smartExtra"></div>

        <!-- Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© 1..6 -->
        <ul class="smart-rules">
          <li>1ï¸âƒ£ Ù„Ø§ Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¹Ø± Ù‚Ø±ÙŠØ¨Ù‹Ø§ Ù…Ù† <strong>EMA21</strong> ÙˆØ¨Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù†ÙØ³Ù‡ (ÙÙˆÙ‚Ù‡Ø§ Ù„Ù„Ø´Ø±Ø§Ø¡ â€“ ØªØ­ØªÙ‡Ø§ Ù„Ù„Ø¨ÙŠØ¹).</li>
          <li>2ï¸âƒ£ ÙØ¶Ù‘Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ£ØªÙŠ ÙÙŠÙ‡Ø§ Ø´ÙƒÙ„ Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠØ© ÙˆØ§Ø¶Ø­Ù‹Ø§ (Ø§Ø¨ØªÙ„Ø§Ø¹ÙŠØ©ØŒ Ø¨ÙŠÙ† Ø¨Ø§Ø±ØŒ Ø¯ÙˆØ¬ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø¯Ù‘) Ø¨Ø¯Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø¶Ø¹ÙŠÙØ©.</li>
          <li>3ï¸âƒ£ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† <strong>RSI</strong> ÙÙŠ ØªØ´Ø¨Ù‘Ø¹ (Ø£Ø¹Ù„Ù‰ Ù…Ù† 70 Ø£Ùˆ Ø£Ù‚Ù„ Ù…Ù† 30)ØŒ Ø§Ø¹ØªØ¨Ø± Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø£Ù‚ÙˆÙ‰ Ù„ÙƒÙ† Ø®ÙÙ‘Ù Ø­Ø¬Ù… Ø§Ù„Ø¹Ù‚Ø¯.</li>
          <li>4ï¸âƒ£ Ø§Ø³ØªØ®Ø¯Ù… <strong>ATR</strong> Ù„ÙˆØ¶Ø¹ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©: Ø¹Ø§Ø¯Ø©Ù‹ Ø¨ÙŠÙ† 1Ã— Ø¥Ù„Ù‰ 1.5Ã— ATR ÙˆØ±Ø§Ø¡ Ø¢Ø®Ø± Ù‚Ø§Ø¹/Ù‚Ù…Ø© Ù…Ù†Ø·Ù‚ÙŠØ©.</li>
          <li>5ï¸âƒ£ Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø±Ø¨Ø­ Ø¹Ù„Ù‰ Ù…Ø±Ø­Ù„ØªÙŠÙ†: <strong>TP1</strong> Ø¹Ù†Ø¯ 1Ã— Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ØŒ Ùˆ<strong>TP2</strong> Ø¹Ù†Ø¯ 2Ã—â€“3Ã— Ù…Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø³ØªÙˆØ¨ Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ TP1.</li>
          <li>6ï¸âƒ£ Ù„Ø§ ØªØ¯Ø®Ù„ Ø£ÙƒØ«Ø± Ù…Ù† ØµÙÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø¹Ù„Ù‰ Ù†ÙØ³ TFØŒ ÙˆØ§Ù†ØªØ¨Ù‡ Ù„Ø­Ø¬Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø§Ø·Ø± Ù‚Ø¨Ù„ Ø£ÙŠ Ø´ÙŠØ¡).</li>
        </ul>

        <div class="smart-dot"></div>
      </div>
    </section>

    <footer>
      Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ â€“ ÙŠÙØ¶Ù‘Ù„ Ø¯Ø§Ø¦Ù…Ù‹Ø§ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø±ÙƒØ© Ù…Ù† Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù‚Ø¨Ù„ Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±.
    </footer>
  </div>

  <script>
    // ========= Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =========
    const workerInput = document.getElementById("workerUrl");
    const tfSelect = document.getElementById("tfSelect");
    const limitInput = document.getElementById("limitInput");

    const livePriceEl = document.getElementById("livePrice");
    const lastPriceUpdateEl = document.getElementById("lastPriceUpdate");
    const lastCloseEl = document.getElementById("lastClose");
    const lastTfEl = document.getElementById("lastTf");
    const dataStatusEl = document.getElementById("dataStatus");
    const candlesCountTagEl = document.getElementById("candlesCountTag");

    const tfLabelEl = document.getElementById("tfLabel");
    const candlesCountEl = document.getElementById("candlesCount");

    const emaValEl = document.getElementById("emaVal");
    const rsiValEl = document.getElementById("rsiVal");
    const atrValEl = document.getElementById("atrVal");
    const bbWidthValEl = document.getElementById("bbWidthVal");
    const lastSignalEl = document.getElementById("lastSignal");

    const smartTextEl = document.getElementById("smartText");
    const smartExtraEl = document.getElementById("smartExtra");

    const autoCandlesCheckbox = document.getElementById("autoCandles");
    const autoPriceCheckbox = document.getElementById("autoPrice");

    const btnFetchPrice = document.getElementById("btnFetchPrice");
    const btnFetchCandles = document.getElementById("btnFetchCandles");
    const btnSaveUrl = document.getElementById("btnSaveUrl");

    // ========= Ø­ÙØ¸ / ØªØ­Ù…ÙŠÙ„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆÙˆØ±ÙƒØ± =========
    const DEFAULT_WORKER =
      "https://goldsignalsx-worker.samer-mourtada.workers.dev";

    function loadWorkerUrl() {
      const saved = localStorage.getItem("gsx_worker_url");
      workerInput.value = saved || DEFAULT_WORKER;
    }

    function saveWorkerUrl() {
      const url = workerInput.value.trim();
      if (!url) return;
      localStorage.setItem("gsx_worker_url", url);
      btnSaveUrl.classList.add("saved");
      setTimeout(() => btnSaveUrl.classList.remove("saved"), 700);
    }

    btnSaveUrl.addEventListener("click", saveWorkerUrl);
    loadWorkerUrl();

    function nowTime() {
      const d = new Date();
      return d.toLocaleTimeString("ar-LB", {
        hour12: false,
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
    }

    function formatPrice(p) {
      if (p == null || isNaN(p)) return "â€”";
      return Number(p).toFixed(2);
    }

    // ========= Ø§Ù„Ø´Ø§Ø±Øª =========
    let chart;
    let candleSeries;
    let emaSeries;
    let bbUpperSeries;
    let bbLowerSeries;

    function initChart() {
      const container = document.getElementById("chart");
      chart = LightweightCharts.createChart(container, {
        layout: {
          background: { color: "transparent" },
          textColor: "#e5e7eb",
        },
        localization: {
          locale: "en-US",
        },
        rightPriceScale: {
          borderVisible: false,
        },
        timeScale: {
          borderVisible: false,
          timeVisible: true,
          secondsVisible: false,
        },
        grid: {
          horzLines: {
            color: "#111827",
          },
          vertLines: {
            color: "#111827",
          },
        },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Normal,
        },
      });

      candleSeries = chart.addCandlestickSeries({
        upColor: "#22c55e",
        downColor: "#ef4444",
        borderUpColor: "#22c55e",
        borderDownColor: "#ef4444",
        wickUpColor: "#22c55e",
        wickDownColor: "#ef4444",
      });

      emaSeries = chart.addLineSeries({
        color: "#60a5fa",
        lineWidth: 2,
      });

      bbUpperSeries = chart.addLineSeries({
        color: "#a855f7",
        lineWidth: 1,
      });

      bbLowerSeries = chart.addLineSeries({
        color: "#a855f7",
        lineWidth: 1,
      });
    }

    initChart();

    // ========= Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª =========
    function ema(values, period) {
      const k = 2 / (period + 1);
      let emaArr = [];
      let prev;
      for (let i = 0; i < values.length; i++) {
        const v = values[i];
        if (v == null) {
          emaArr.push(null);
          continue;
        }
        if (prev == null) {
          prev = v;
        } else {
          prev = v * k + prev * (1 - k);
        }
        emaArr.push(prev);
      }
      return emaArr;
    }

    function rsi(values, period = 14) {
      let gains = 0,
        losses = 0;
      let rsis = [];
      for (let i = 1; i < values.length; i++) {
        const diff = values[i] - values[i - 1];
        if (i <= period) {
          if (diff > 0) gains += diff;
          else losses -= diff;
          rsis.push(null);
          if (i === period) {
            const avgGain = gains / period;
            const avgLoss = losses / period || 1e-9;
            const rs = avgGain / avgLoss;
            rsis[i - 1] = 100 - 100 / (1 + rs);
          }
        } else {
          const gain = diff > 0 ? diff : 0;
          const loss = diff < 0 ? -diff : 0;
          gains = (gains * (period - 1) + gain) / period;
          losses = (losses * (period - 1) + loss) / period || 1e-9;
          const rs = gains / losses;
          rsis.push(100 - 100 / (1 + rs));
        }
      }
      rsis.unshift(null); // align length
      return rsis;
    }

    function atr(bars, period = 14) {
      let trs = [];
      for (let i = 0; i < bars.length; i++) {
        const b = bars[i];
        if (!b) {
          trs.push(null);
          continue;
        }
        const high = b.h;
        const low = b.l;
        const prevClose = i > 0 ? bars[i - 1].c : b.c;
        const tr = Math.max(
          high - low,
          Math.abs(high - prevClose),
          Math.abs(low - prevClose)
        );
        trs.push(tr);
      }
      const at = ema(trs, period);
      return at;
    }

    function bollinger(values, period = 20, mult = 2) {
      let upper = [];
      let lower = [];
      for (let i = 0; i < values.length; i++) {
        if (i < period - 1 || values[i] == null) {
          upper.push(null);
          lower.push(null);
          continue;
        }
        let slice = values.slice(i - period + 1, i + 1);
        const mean =
          slice.reduce((sum, v) => sum + (v || 0), 0) / slice.length;
        const variance =
          slice.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) /
          slice.length;
        const std = Math.sqrt(variance);
        upper.push(mean + mult * std);
        lower.push(mean - mult * std);
      }
      return { upper, lower };
    }

    // ========= Ù…Ù†Ø·Ù‚ OnlyWhenSignal =========
    function buildSmartText({
      ema21,
      rsi14,
      atr14,
      bbWidth,
      livePrice,
      lastClose,
    }) {
      if (
        ema21 == null ||
        rsi14 == null ||
        atr14 == null ||
        bbWidth == null
      ) {
        return {
          main:
            "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª. Ø­Ø§ÙˆÙ„ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù€ Limit Ø£Ùˆ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªÙƒØªÙ…Ù„ Ø§Ù„Ø´Ù…ÙˆØ¹.",
          extra: "",
          signal: "â€”",
        };
      }

      const price = livePrice != null ? livePrice : lastClose;

      // Ø´Ø±ÙˆØ· OnlyWhenSignal ÙƒÙ…Ø§ Ø§ØªÙÙ‚Ù†Ø§:
      const rsiOK = rsi14 > 35 && rsi14 < 65; // Ù„Ø§ ØªØ´Ø¨Ù‘Ø¹ Ù‚ÙˆÙŠ
      const emaDiffPct = ema21
        ? ((price - ema21) / ema21) * 100
        : 0;
      const gluedToEma = Math.abs(emaDiffPct) < 0.15; // Ø§Ù„Ø³Ø¹Ø± Ù…Ù„Ø²Ù‘Ù‚ Ø¨Ù€ EMA21 ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§
      const hasVol = atr14 > 0; // Volatility Ù…ÙˆØ¬ÙˆØ¯Ø©

      let direction = null; // "long" Ø£Ùˆ "short"

      if (rsiOK && hasVol && !gluedToEma) {
        // Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± ÙÙˆÙ‚ EMA21 Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ â†’ Ø§ØªØ¬Ø§Ù‡ ØµØ§Ø¹Ø¯
        if (emaDiffPct > 0) direction = "long";
        // Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± ØªØ­Øª EMA21 Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ â†’ Ø§ØªØ¬Ø§Ù‡ Ù‡Ø§Ø¨Ø·
        if (emaDiffPct < 0) direction = "short";
      }

      // Ù„Ùˆ Ù…Ø§ ÙÙŠ ØµÙÙ‚Ø© ÙˆØ§Ø¶Ø­Ø© â†’ Ù†Øµ ÙˆØ§Ø­Ø¯ Ø«Ø§Ø¨Øª
      if (!direction) {
        const reasons = [];
        if (!rsiOK) reasons.push("RSI Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ 35-65");
        if (gluedToEma)
          reasons.push("Ø§Ù„Ø³Ø¹Ø± Ù…Ù„ØªØµÙ‚ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ø¨Ù€ EMA21 (Ø³ÙˆÙ‚ Ø¬Ø§Ù†Ø¨ÙŠ)");
        if (!hasVol) reasons.push("ATR Ø¶Ø¹ÙŠÙ (ØªÙ‚Ù„Ø¨ Ù‚Ù„ÙŠÙ„)");

        return {
          main:
            "Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø© ÙˆØ§Ø¶Ø­Ø© Ø§Ù„Ø¢Ù† (OnlyWhenSignal).\nØ§Ù†ØªØ¸Ø± Ø¥Ø´Ø§Ø±Ø© Ø£ÙˆØ¶Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„.",
          extra: reasons.length ? "Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨: " + reasons.join(" â€¢ ") : "",
          signal: "No trade",
        };
      }

      // ÙŠÙˆØ¬Ø¯ ØµÙÙ‚Ø© â†’ Ù†Ø­Ø³Ø¨ Entry / SL / TP1 / TP2
      const riskATR = atr14 || Math.abs(price * 0.002); // fallback Ø¨Ø³ÙŠØ·
      const risk = riskATR * 1.2;

      let entry = price;
      let sl, tp1, tp2;

      if (direction === "long") {
        sl = entry - risk;
        tp1 = entry + riskATR * 1.5;
        tp2 = entry + riskATR * 3;
      } else {
        sl = entry + risk;
        tp1 = entry - riskATR * 1.5;
        tp2 = entry - riskATR * 3;
      }

      const mainLines = [
        `Ù†ÙˆØ¹ Ø§Ù„ØµÙÙ‚Ø©: ${direction === "long" ? "Ø´Ø±Ø§Ø¡ (Long)" : "Ø¨ÙŠØ¹ (Short)"}`,
        `Ø§Ù„Ø¯Ø®ÙˆÙ„ (Entry): ${entry.toFixed(2)}`,
        `ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© (SL): ${sl.toFixed(2)}`,
        `TP1: ${tp1.toFixed(2)}`,
        `TP2: ${tp2.toFixed(2)}`,
      ];

      const extraLines = [
        `RSI(14): ${rsi14.toFixed(1)}`,
        `EMA21: ${ema21.toFixed(2)}`,
        `ATR(14): ${atr14.toFixed(2)}`,
        `BB width: ${bbWidth.toFixed(2)}%`,
      ];

      return {
        main: mainLines.join("\n"),
        extra: extraLines.join(" â€¢ "),
        signal: direction === "long" ? "Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡" : "Ø¥Ø´Ø§Ø±Ø© Ø¨ÙŠØ¹",
      };
    }

    // ========= Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙˆÙˆØ±ÙƒØ± =========
    async function fetchJson(url) {
      const res = await fetch(url, { cf: { cacheTtl: 0 } }).catch(() => null);
      if (!res || !res.ok) throw new Error("HTTP Error");
      return res.json();
    }

    async function getLivePrice() {
      const base = workerInput.value.trim() || DEFAULT_WORKER;
      const url = base.replace(/\/$/, "") + "/price";
      const json = await fetchJson(url);
      // ØªÙˆÙ‚Ø¹ Ø´ÙƒÙ„ { price, time } Ø£Ùˆ {p, t}
      const price = Number(json.price ?? json.p ?? json.last ?? json.value);
      return {
        price: isNaN(price) ? null : price,
        raw: json,
      };
    }

    async function getBars(tf, limit) {
      const base = workerInput.value.trim() || DEFAULT_WORKER;
      const url =
        base.replace(/\/$/, "") + "/bars?tf=" + encodeURIComponent(tf) +
        "&limit=" + encodeURIComponent(limit);
      const arr = await fetchJson(url);
      // Ù†ØªÙˆÙ‚Ø¹ Ø´ÙƒÙ„ [{t,o,h,l,c,v}, ...]
      return Array.isArray(arr) ? arr : [];
    }

    // ========= Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ¯Ù…Ø¬ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ Ù…Ø¹ Ø¢Ø®Ø± Ø´Ù…Ø¹Ø© =========
    let lastBars = [];
    let lastLivePrice = null;
    let autoPriceTimer = null;
    let autoCandlesTimer = null;

    function mergeLiveIntoLastBar(bars, livePrice) {
      if (!bars.length) return bars;
      if (livePrice == null || isNaN(livePrice)) return bars;

      const cloned = bars.map((b) => ({ ...b }));
      const last = cloned[cloned.length - 1];

      if (last.c == null) last.c = last.o;
      if (last.h == null) last.h = Math.max(last.o, last.c);
      if (last.l == null) last.l = Math.min(last.o, last.c);

      last.c = Number(livePrice);
      if (last.c > last.h) last.h = last.c;
      if (last.c < last.l) last.l = last.c;

      cloned[cloned.length - 1] = last;
      return cloned;
    }

    function updatePriceUI(price) {
      if (price == null || isNaN(price)) {
        livePriceEl.textContent = "â€”";
        return;
      }
      livePriceEl.textContent = formatPrice(price);
      lastPriceUpdateEl.textContent = nowTime();
    }

    function updateCandlesUI(bars, tf) {
      tfLabelEl.textContent = bars.length ? tf : "â€”";
      candlesCountEl.textContent = bars.length || "â€”";
      candlesCountTagEl.textContent = "Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù…ÙˆØ¹: " + (bars.length || "â€”");
      lastTfEl.textContent = bars.length ? tf : "â€”";

      if (!bars.length) {
        dataStatusEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ù…ÙˆØ¹ ÙƒØ§ÙÙŠØ©.";
      } else {
        dataStatusEl.textContent = "ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­.";
      }
    }

    function drawChartWithIndicators(bars, livePrice) {
      lastBars = bars;
      if (!bars.length) {
        candleSeries.setData([]);
        emaSeries.setData([]);
        bbUpperSeries.setData([]);
        bbLowerSeries.setData([]);
        emaValEl.textContent = "â€”";
        rsiValEl.textContent = "â€”";
        atrValEl.textContent = "â€”";
        bbWidthValEl.textContent = "â€”";
        lastSignalEl.textContent = "â€”";
        smartTextEl.textContent =
          "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª...";
        smartExtraEl.textContent = "";
        return;
      }

      const candleData = bars.map((b) => ({
        time: Math.floor(Number(b.t) / 1000),
        open: Number(b.o),
        high: Number(b.h),
        low: Number(b.l),
        close: Number(b.c),
      }));

      candleSeries.setData(candleData);

      const closes = candleData.map((c) => c.close);

      const ema21Arr = ema(closes, 21);
      const rsi14Arr = rsi(closes, 14);
      const atr14Arr = atr(
        bars.map((b) => ({
          h: Number(b.h),
          l: Number(b.l),
          c: Number(b.c),
        })),
        14
      );
      const bb = bollinger(closes, 20, 2);

      const emaSeriesData = candleData.map((c, idx) => ({
        time: c.time,
        value: ema21Arr[idx],
      }));
      const bbUpperData = candleData.map((c, idx) => ({
        time: c.time,
        value: bb.upper[idx],
      }));
      const bbLowerData = candleData.map((c, idx) => ({
        time: c.time,
        value: bb.lower[idx],
      }));

      emaSeries.setData(emaSeriesData.filter((p) => p.value != null));
      bbUpperSeries.setData(bbUpperData.filter((p) => p.value != null));
      bbLowerSeries.setData(bbLowerData.filter((p) => p.value != null));

      const lastIdx = candleData.length - 1;
      const ema21 = ema21Arr[lastIdx];
      const rsi14 = rsi14Arr[lastIdx];
      const atr14 = atr14Arr[lastIdx];
      const upper = bb.upper[lastIdx];
      const lower = bb.lower[lastIdx];
      const lastClose = candleData[lastIdx].close;

      const bbWidth =
        upper != null && lower != null && lastClose
          ? ((upper - lower) / lastClose) * 100
          : null;

      emaValEl.textContent = ema21 ? ema21.toFixed(2) : "â€”";
      rsiValEl.textContent = rsi14 ? rsi14.toFixed(1) : "â€”";
      atrValEl.textContent = atr14 ? atr14.toFixed(2) : "â€”";
      bbWidthValEl.textContent = bbWidth ? bbWidth.toFixed(2) + "%" : "â€”";

      const { main, extra, signal } = buildSmartText({
        ema21,
        rsi14,
        atr14,
        bbWidth,
        livePrice,
        lastClose,
      });

      smartTextEl.textContent = main;
      smartExtraEl.textContent = extra;
      lastSignalEl.textContent = signal || "â€”";

      lastCloseEl.textContent = formatPrice(lastClose);
    }

    async function refreshPrice(merge = true) {
      try {
        const { price } = await getLivePrice();
        lastLivePrice = price;
        updatePriceUI(price);

        if (merge && lastBars.length) {
          const merged = mergeLiveIntoLastBar(lastBars, price);
          drawChartWithIndicators(merged, price);
        }
      } catch (err) {
        livePriceEl.textContent = "â€”";
        lastPriceUpdateEl.textContent = "ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«";
      }
    }

    async function refreshCandles() {
      const tf = tfSelect.value;
      const limit = Number(limitInput.value) || 800;

      dataStatusEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹...";
      try {
        const barsRaw = await getBars(tf, limit);
        const barsClean = barsRaw
          .map((b) => ({
            t: Number(b.t ?? b.time ?? b.timestamp),
            o: Number(b.o ?? b.open),
            h: Number(b.h ?? b.high),
            l: Number(b.l ?? b.low),
            c: Number(b.c ?? b.close),
            v: Number(b.v ?? b.volume ?? 0),
          }))
          .filter(
            (b) =>
              !isNaN(b.t) &&
              !isNaN(b.o) &&
              !isNaN(b.h) &&
              !isNaN(b.l) &&
              !isNaN(b.c)
          );

        const merged = mergeLiveIntoLastBar(barsClean, lastLivePrice);
        updateCandlesUI(merged, tf);
        drawChartWithIndicators(merged, lastLivePrice);
      } catch (err) {
        console.error(err);
        dataStatusEl.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹.";
      }
    }

    // ========= Ø§Ù„ØªØ§ÙŠÙ…Ø±Ø§Øª =========
    function startAutoLoops() {
      if (autoPriceCheckbox.checked && !autoPriceTimer) {
        // Ù„Ùˆ Ø¨Ø¯Ùƒ 1 Ø«Ø§Ù†ÙŠØ© Ø¨Ø¯Ù„ 2 â†’ ØºÙŠÙ‘Ø± 2000 Ø¥Ù„Ù‰ 1000 Ù‡ÙˆÙ† ÙˆÙ‡ÙˆÙ†
        autoPriceTimer = setInterval(() => refreshPrice(true), 2000);
      }
      if (autoCandlesCheckbox.checked && !autoCandlesTimer) {
        autoCandlesTimer = setInterval(refreshCandles, 2000);
      }
    }

    function stopAutoLoops() {
      if (!autoPriceCheckbox.checked && autoPriceTimer) {
        clearInterval(autoPriceTimer);
        autoPriceTimer = null;
      }
      if (!autoCandlesCheckbox.checked && autoCandlesTimer) {
        clearInterval(autoCandlesTimer);
        autoCandlesTimer = null;
      }
    }

    autoPriceCheckbox.addEventListener("change", () => {
      if (autoPriceCheckbox.checked) {
        refreshPrice(true);
      }
      startAutoLoops();
      stopAutoLoops();
    });

    autoCandlesCheckbox.addEventListener("change", () => {
      if (autoCandlesCheckbox.checked) {
        refreshCandles();
      }
      startAutoLoops();
      stopAutoLoops();
    });

    // ========= Ø§Ù„Ø£Ø­Ø¯Ø§Ø« =========
    btnFetchPrice.addEventListener("click", () => refreshPrice(true));
    btnFetchCandles.addEventListener("click", () => refreshCandles());

    // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
    (async function init() {
      await refreshCandles();
      await refreshPrice(true);
      startAutoLoops();
    })();
  </script>
</body>
</html>
