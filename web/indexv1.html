<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoldSignalsX â€¢ Ultimate</title>

  <!-- Ø®Ø· Ø¨Ø³ÙŠØ· -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#02040a;
      color:#f5f5f5;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:460px;
      margin:auto;
    }
    .card{
      background:radial-gradient(circle at top,#141c2b,#050811 60%);
      border-radius:24px;
      padding:20px 18px 18px;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:0 18px 45px rgba(0,0,0,0.55);
    }
    .title{
      font-size:22px;
      font-weight:700;
      text-align:center;
      margin-bottom:4px;
    }
    .subtitle{
      font-size:12px;
      text-align:center;
      color:#c9d4ff;
      opacity:.8;
      margin-bottom:10px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .label{
      font-size:12px;
      color:#b2bdd8;
      margin-bottom:4px;
      display:block;
    }
    .pill{
      background:#050913;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:#d5e0ff;
    }
    .status-dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:#22c55e;
    }
    .input, select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.08);
      background:#050913;
      color:#e5ecff;
      font-size:13px;
      outline:none;
    }
    .input::placeholder{color:#6d768f;}
    select{
      appearance:none;
      padding-inline-start:16px;
    }
    .btn{
      border:none;
      border-radius:18px;
      padding:10px 14px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:.16s ease;
      white-space:nowrap;
    }
    .btn:disabled{
      opacity:.55;
      cursor:default;
    }
    .btn-primary{
      background:linear-gradient(135deg,#f9af3c,#f97316);
      color:#1b1304;
      box-shadow:0 10px 25px rgba(249,115,22,0.45);
    }
    .btn-primary:active{transform:translateY(1px);}
    .btn-secondary{
      background:#0b1220;
      color:#e5ecff;
      border:1px solid rgba(148,163,235,0.5);
    }
    .small-pill-row{
      display:flex;
      gap:8px;
      margin-top:8px;
      flex-wrap:wrap;
    }
    .tag{
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.06);
      font-size:11px;
      color:#cbd5f5;
      opacity:.9;
    }
    .tag span{
      color:#fbbf24;
      margin-inline-start:4px;
    }
    .section-title{
      font-size:12px;
      color:#a3b0d6;
      margin:12px 0 4px;
    }
    .panel{
      margin-top:12px;
      padding:10px 12px;
      border-radius:16px;
      background:#050913;
      border:1px dashed rgba(148,163,235,0.45);
      font-size:12px;
      color:#cbd5f5;
      min-height:40px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .price-value{
      font-weight:700;
      font-size:18px;
      color:#facc15;
    }
    #chart-container{
      margin-top:12px;
      background:#020617;
      border-radius:18px;
      border:1px solid rgba(30,64,175,0.75);
      padding:6px;
      height:360px;
      position:relative;
      overflow:hidden;
    }
    #chart{
      width:100%;
      height:100%;
    }
    #chart-msg{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      color:#94a3b8;
      pointer-events:none;
      text-align:center;
      padding:16px;
    }
    .footer{
      margin-top:10px;
      font-size:10px;
      text-align:center;
      color:#64748b;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="title">GoldSignalsX â€¢ Ultimate</div>
      <div class="subtitle">
        Ø³Ø¹Ø± Ø­ÙŠ + Ø´Ù…ÙˆØ¹ ÙŠØ§Ø¨Ø§Ù†ÙŠØ© + Ù…Ø¤Ø´Ø±Ø§Øª (EMA, RSI, Stoch, MACD) + Ù†ØµÙŠØ­Ø© Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬
      </div>

      <div class="row" style="justify-content:space-between;margin-bottom:14px;">
        <div class="pill">
          <div class="status-dot" id="worker-dot"></div>
          <span id="worker-status-label">Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù€ Worker</span>
        </div>
        <div style="font-size:11px;color:#9ca3af;">
          Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="last-update">â€”</span>
        </div>
      </div>

      <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
      <div class="row">
        <div style="flex:1;">
          <span class="label">Limit</span>
          <input id="limit-input" class="input" type="number" min="50" max="5000" value="800">
        </div>
        <div style="width:110px;">
          <span class="label">TF</span>
          <select id="tf-select" class="input">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m">15m</option>
            <option value="30m">30m</option>
            <option value="60m">60m</option>
            <option value="240m">4h</option>
            <option value="1d">1d</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom:10px;">
        <span class="label">Worker URL</span>
        <input id="worker-url" class="input"
          placeholder="https://goldsignalsx-worker.samer-mourtada.workers.dev">
      </div>

      <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <div class="row">
        <button id="btn-price" class="btn btn-primary" style="flex:1;">
          ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ ğŸ’²
        </button>
        <button id="btn-bars" class="btn btn-secondary" style="flex:1;">
          Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ ÙˆØ±Ø³Ù… Ø§Ù„Ø´Ø§Ø±Øª ğŸ“Š
        </button>
      </div>

      <!-- Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª / Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚: Ù…Ø¬Ø±Ø¯ Tags Ø´ÙƒÙ„ÙŠØ© Ø§Ù„Ø¢Ù† -->
      <div class="section-title">Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª</div>
      <div class="small-pill-row">
        <div class="tag">Ø³Ø±ÙŠØ¹ <span>âš¡</span></div>
        <div class="tag">Ø°ÙƒÙŠ <span>ğŸ§ </span></div>
        <div class="tag">Ø­Ø°Ø± <span>ğŸ›¡</span></div>
      </div>

      <div class="section-title">Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚</div>
      <div class="small-pill-row">
        <div class="tag">ØªÙ„Ù‚Ø§Ø¦ÙŠ <span>ğŸ¤–</span></div>
        <div class="tag">ØªØ±Ù†Ø¯ <span>ğŸ“ˆ</span></div>
        <div class="tag">Ø±Ù†Ø¬ <span>ğŸ“Š</span></div>
        <div class="tag">Ø­ÙŠØ§Ø¯ÙŠ <span>âšª</span></div>
      </div>

      <!-- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ + Ù†ØµÙŠØ­Ø© ØµØºÙŠØ±Ø© -->
      <div class="panel">
        <div>
          Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ:
          <span class="price-value" id="live-price">â€”</span>
        </div>
        <div id="advice" style="font-size:11px;color:#a5b4fc;">
          Ù†ØµÙŠØ­Ø©: Ø§Ù†ØªØ¸Ø± Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡.
        </div>
      </div>

      <!-- Ø§Ù„Ø´Ø§Ø±Øª -->
      <div id="chart-container">
        <div id="chart"></div>
        <div id="chart-msg">Ø§Ø¶ØºØ· "Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ ÙˆØ±Ø³Ù… Ø§Ù„Ø´Ø§Ø±Øª" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù…ÙˆØ¹ Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠØ©â€¦</div>
      </div>

      <div class="footer">
        GSX â€¢ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© â€” Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ D1 + Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ù…ÙˆØ¹ Ø³ÙŠØªÙˆØ³Ø¹ Ù„Ø§Ø­Ù‚Ù‹Ø§
      </div>
    </div>
  </div>

<script>
(function(){
  const DEFAULT_WORKER = "https://goldsignalsx-worker.samer-mourtada.workers.dev";

  const workerInput = document.getElementById("worker-url");
  const limitInput  = document.getElementById("limit-input");
  const tfSelect    = document.getElementById("tf-select");
  const btnPrice    = document.getElementById("btn-price");
  const btnBars     = document.getElementById("btn-bars");
  const priceSpan   = document.getElementById("live-price");
  const statusDot   = document.getElementById("worker-dot");
  const statusLabel = document.getElementById("worker-status-label");
  const lastUpdate  = document.getElementById("last-update");
  const chartContainer = document.getElementById("chart-container");
  const chartDiv    = document.getElementById("chart");
  const chartMsg    = document.getElementById("chart-msg");

  let chart = null;
  let candleSeries = null;

  // Ø­Ø· Ø§Ù„Ù€ URL ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø¶ÙŠ
  if (!workerInput.value.trim()) {
    workerInput.value = DEFAULT_WORKER;
  }

  function getBase(){
    let v = workerInput.value.trim();
    if (!v) v = DEFAULT_WORKER;
    // Ø´ÙŠÙ„ Ø£ÙŠ / Ø¨Ø§Ù„Ø¢Ø®Ø±
    v = v.replace(/\/+$/g,"");
    return v;
  }

  function setWorkerStatus(ok){
    if(ok){
      statusDot.style.background = "#22c55e";
      statusLabel.textContent = "Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù€ Worker";
    }else{
      statusDot.style.background = "#ef4444";
      statusLabel.textContent = "ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù€ Worker";
    }
  }

  async function pingWorker(){
    try{
      const r = await fetch(getBase() + "/health", {cf:{cacheTtl:0}});
      setWorkerStatus(r.ok);
    }catch(e){
      console.warn("health error", e);
      setWorkerStatus(false);
    }
  }

  async function fetchJSON(path){
    const url = getBase() + path;
    const r = await fetch(url, {headers:{accept:"application/json"}, cf:{cacheTtl:0}});
    if(!r.ok) throw new Error("HTTP " + r.status + " for " + path);
    return await r.json();
  }

  function touchTimestamp(){
    const d = new Date();
    lastUpdate.textContent = d.toLocaleTimeString("en-GB",{hour12:false});
  }

  // ==== Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ ====
  async function updatePrice(){
    btnPrice.disabled = true;
    try{
      const j = await fetchJSON("/price");
      console.log("[GSX] price resp:", j);
      if(j && j.ok && Number.isFinite(j.price)){
        priceSpan.textContent = j.price.toFixed(2);
        touchTimestamp();

        // Ù†ØµÙŠØ­Ø© Ø¨Ø³ÙŠØ·Ø© Ø­Ø³Ø¨ Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ø¹Ø±
        const src = j.source || "";
        document.getElementById("advice").textContent =
          (src === "gold-ticks")
          ? "Ø§Ù„Ø³Ø¹Ø± Ù…Ø¨Ø§Ø´Ø± Ù…Ù† gold-ticks â€” Ø±Ø§Ù‚Ø¨ ÙƒØ³Ø± Ø§Ù„Ù‚Ù…Ù… ÙˆØ§Ù„Ù‚ÙŠØ¹Ø§Ù† Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©."
          : "Ø§Ù„Ø³Ø¹Ø± Ù…Ù† stooq (Ø§Ø­ØªÙŠØ§Ø·ÙŠ) â€” ÙŠÙØ¶Ù‘Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø±ÙƒØ© Ù…Ù† Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„.";
      }else{
        priceSpan.textContent = "Ø®Ø·Ø£";
      }
    }catch(e){
      console.error("price error", e);
      priceSpan.textContent = "ERR";
      setWorkerStatus(false);
    }finally{
      btnPrice.disabled = false;
    }
  }

  // ====== Ø§Ù„Ø´Ø§Ø±Øª ======
  function ensureChart(){
    if(chart) return;
    chart = LightweightCharts.createChart(chartDiv, {
      layout:{background:{type:"solid",color:"#020617"}, textColor:"#cbd5f5"},
      grid:{
        vertLines:{color:"rgba(148,163,184,0.12)"},
        horzLines:{color:"rgba(148,163,184,0.12)"}
      },
      rightPriceScale:{borderColor:"rgba(148,163,184,0.3)"},
      timeScale:{borderColor:"rgba(148,163,184,0.3)", timeVisible:true, secondsVisible:false},
      crosshair:{mode: LightweightCharts.CrosshairMode.Normal}
    });
    candleSeries = chart.addCandlestickSeries({
      upColor:"#22c55e", downColor:"#ef4444",
      wickUpColor:"#22c55e", wickDownColor:"#ef4444",
      borderVisible:false
    });
  }

  async function fetchBars(){
    btnBars.disabled = true;
    chartMsg.textContent = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† Ø§Ù„Ù€ Workerâ€¦";

    try{
      const limit = Math.max(50, Math.min(5000, parseInt(limitInput.value || "800",10)));
      const tf    = tfSelect.value || "1m";
      const path  = `/bars?tf=${encodeURIComponent(tf)}&limit=${limit}`;

      const j = await fetchJSON(path);
      console.log("[GSX] bars raw:", j);

      if(!Array.isArray(j) || !j.length){
        chartMsg.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ù…ÙˆØ¹ (Ø§Ù„Ù€ D1 ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©).";
        ensureChart();
        candleSeries.setData([]); // ÙØ§Ø¶ÙŠ Ø¨Ø¯ÙˆÙ† null
        return;
      }

      // ØªÙ†Ø¸ÙŠÙ ÙˆØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù€ lightweight-charts
      const data = j
        .map(b => ({
          t: Number(b.t),
          o: Number(b.o),
          h: Number(b.h),
          l: Number(b.l),
          c: Number(b.c),
          v: Number(b.v)
        }))
        .filter(b =>
          Number.isFinite(b.t) &&
          Number.isFinite(b.o) &&
          Number.isFinite(b.h) &&
          Number.isFinite(b.l) &&
          Number.isFinite(b.c)
        )
        .map(b => ({
          time: Math.floor(b.t / 1000), // Ø«ÙˆØ§Ù†ÙŠ
          open: b.o,
          high: b.h,
          low : b.l,
          close:b.c
        }));

      console.log("[GSX] bars cleaned sample:", data.slice(0,5));

      ensureChart();
      if(!data.length){
        chartMsg.textContent = "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„Ø±Ø³Ù… (ÙƒÙ„Ù‡Ø§ null).";
        candleSeries.setData([]);
        return;
      }

      candleSeries.setData(data);
      chart.timeScale().fitContent();
      chartMsg.textContent = "";
      touchTimestamp();

    }catch(e){
      console.error("bars error", e);
      chartMsg.textContent = "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† Ø§Ù„Ù€ Worker. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ URL ÙˆØ§Ù„Ù€ D1.";
      setWorkerStatus(false);
    }finally{
      btnBars.disabled = false;
    }
  }

  // ===== events =====
  btnPrice.addEventListener("click", updatePrice);
  btnBars.addEventListener("click", fetchBars);

  // Ø¨Ù…Ø¬Ø±Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©: Ø§ÙØ­Øµ Ø§Ù„Ù€ Worker ÙˆØ¬ÙŠØ¨ Ø£ÙˆÙ„ Ø³Ø¹Ø±
  pingWorker();
  updatePrice();
})();
</script>
</body>
</html>
