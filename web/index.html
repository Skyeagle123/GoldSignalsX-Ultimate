<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>GoldSignalsX â€¢ Ultimate</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #050814;
      --bg-elevated: #0b1020;
      --bg-elevated-soft: #11182a;
      --accent: #fbbf24;
      --accent-soft: rgba(251,191,36,0.08);
      --accent-strong: #f59e0b;
      --danger: #ef4444;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --border-subtle: #1f2933;
      --chip-bg: #111827;
      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.45);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
    }
    .page {
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 10px 40px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 10px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .icon-circle {
      width: 40px; height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #fde68a, #f97316 45%, #451a03 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 25px rgba(251,191,36,0.55);
      color: #111827;
      font-size: 21px;
    }
    .brand-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .brand-title h1 {
      font-size: 19px;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .brand-sub {
      font-size: 11px;
      color: var(--text-soft);
    }
    .pill {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at 0 0,#111827,#020617);
      color: var(--text-muted);
    }
    .pill-dot {
      width: 8px; height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34,197,94,0.8);
    }
    .mode-toggle {
      width: 42px;
      height: 23px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: linear-gradient(to right,#020617,#111827);
      padding: 2px;
      display: flex;
      align-items: center;
      cursor: pointer;
      position: relative;
    }
    .mode-toggle-thumb {
      width: 18px; height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0,#fde68a,#f97316 60%,#451a03);
      box-shadow: 0 0 12px rgba(248,250,252,0.3);
      transform: translateX(0);
      transition: transform 0.22s ease-out;
    }
    .mode-toggle[data-mode="light"] .mode-toggle-thumb {
      transform: translateX(17px);
    }

    .card {
      background: radial-gradient(circle at top left,#111827 0,#020617 50%,#000 100%);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(148,163,184,0.18);
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 14px;
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content:"";
      position:absolute;
      inset:-120px;
      background:
        radial-gradient(circle at 10% -10%,rgba(251,191,36,0.14) 0,transparent 55%),
        radial-gradient(circle at 110% 20%,rgba(59,130,246,0.14) 0,transparent 52%);
      opacity:0.68;
      pointer-events:none;
    }
    .card-inner { position: relative; z-index: 1; }
    .section-title {
      font-size: 13px;
      margin-bottom: 8px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title span {
      font-size: 11px;
      color: var(--text-soft);
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .grow { flex: 1 1 0; }

    .input-shell {
      background: rgba(15,23,42,0.95);
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 4px 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .input-shell input, .input-shell select {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-main);
      font-size: 12px;
      width: 100%;
      direction: ltr;
    }
    .chip {
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid #1f2937;
      padding: 4px 10px;
      font-size: 11px;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .chip strong { color: var(--accent-strong); }

    .btn {
      border: none;
      outline: none;
      font: inherit;
      cursor: pointer;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out, background 0.2s;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(to right,#fbbf24,#f97316);
      color: #111827;
      box-shadow: 0 14px 30px rgba(248,250,252,0.18);
    }
    .btn-primary:active { transform: translateY(1px); box-shadow: 0 6px 18px rgba(0,0,0,0.65); }
    .btn-secondary {
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      border: 1px solid #1f2937;
    }
    .btn-xs { padding: 5px 10px; font-size: 11px; }

    .smart-banner {
      border-radius: var(--radius-lg);
      padding: 10px 11px;
      margin-top: 10px;
      background: linear-gradient(110deg,rgba(34,197,94,0.12),rgba(22,163,74,0.05),rgba(15,23,42,0.98));
      border: 1px solid rgba(34,197,94,0.3);
      font-size: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .smart-banner-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      color: #bbf7d0;
    }
    .smart-dot {
      width: 9px; height: 9px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }
    .smart-msg {
      font-size: 11px;
      color: #e5e7eb;
    }

    #chart-container {
      width: 100%;
      height: 340px;
      margin-top: 8px;
      border-radius: 18px;
      background: radial-gradient(circle at top,#020617,#020617);
      border: 1px solid #111827;
      overflow: hidden;
    }

    .indicator-row {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      margin-top: 8px;
    }

    .advice-card {
      margin-top: 10px;
      border-radius: 18px;
      padding: 11px 12px;
      background: linear-gradient(130deg,rgba(15,23,42,0.98),rgba(8,47,73,0.96));
      border: 1px solid rgba(148,163,184,0.3);
      font-size: 12px;
    }
    .advice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 6px;
    }
    .advice-badges {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: flex-end;
      font-size: 10px;
    }
    .badge {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15,23,42,0.85);
      color: var(--text-soft);
    }
    .levels {
      display: grid;
      grid-template-columns: repeat(4,minmax(0,1fr));
      gap: 6px;
      margin-top: 4px;
      font-size: 11px;
    }
    .level-item {
      background: rgba(15,23,42,0.95);
      border-radius: 999px;
      padding: 4px 7px;
      text-align: center;
      border: 1px solid #1f2937;
    }
    .level-label { color: var(--text-soft); margin-left: 3px; }
    .level-value { font-weight: 600; }

    .advice-reason {
      margin-top: 6px;
      font-size: 11px;
      color: #e5e7eb;
    }
    .advice-reason span {
      color: #93c5fd;
    }

    .status-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      font-size:11px;
      color:var(--text-soft);
    }

    .auto-row {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:var(--text-soft);
      margin-top:6px;
    }
    .auto-row input { accent-color: var(--accent); }

    @media (max-width: 640px) {
      .page { padding-inline: 8px; }
      header { align-items: flex-start; }
    }
  </style>

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="icon-circle">X</div>
        <div class="brand-title">
          <h1>GoldSignalsX <span>â€¢ Ultimate</span></h1>
          <div class="brand-sub">Smart Gold Trading Signals Â· Ø³Ø¹Ø± Ø­ÙŠ + Ø´Ù…ÙˆØ¹ + Ù…Ø¤Ø´Ø±Ø§Øª + Ù†ØµÙŠØ­Ø©</div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;gap:8px;">
        <div class="pill">
          <div class="pill-dot"></div>
          <span>Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù€ Worker</span>
        </div>
        <div class="mode-toggle" id="mode-toggle" data-mode="dark" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">
          <div class="mode-toggle-thumb"></div>
        </div>
      </div>
    </header>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØµØ¯Ø± ÙˆØ§Ù„ØªØ§ÙŠÙ… ÙØ±ÙŠÙ… -->
    <section class="card">
      <div class="card-inner">
        <div class="section-title">
          Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
          <span>Ø§Ø®ØªÙØ± Ø§Ù„ÙˆÙˆØ±ÙƒØ± ÙˆØ§Ù„Ù€ TF ÙˆØ§Ù„Ù€ Limit</span>
        </div>
        <div class="row" style="margin-bottom:8px;">
          <div class="grow">
            <div class="input-shell">
              <span style="white-space:nowrap;font-size:11px;">Worker URL</span>
              <input id="worker-url" placeholder="https://goldsignalsx-worker.samer-mourtada.workers.dev" />
            </div>
          </div>
        </div>
        <div class="row" style="margin-bottom:8px;">
          <div class="input-shell" style="width:120px;">
            <span style="font-size:11px;">Limit</span>
            <input id="limit-input" type="number" min="100" max="2000" step="50" value="800" />
          </div>
          <div class="input-shell" style="width:110px;">
            <span style="font-size:11px;">TF</span>
            <select id="tf-select">
              <option value="1m">1m</option>
              <option value="5m">5m</option>
              <option value="15m">15m</option>
              <option value="30m">30m</option>
              <option value="60m">1h</option>
              <option value="240m">4h</option>
              <option value="1d">Day</option>
            </select>
          </div>
          <button class="btn btn-secondary btn-xs" id="save-url-btn">Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</button>
        </div>

        <div class="row">
          <button class="btn btn-primary" id="live-price-btn">
            ğŸ’² ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ
          </button>
          <button class="btn btn-secondary" id="load-candles-btn">
            ğŸ“Š Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ ÙˆØ±Ø³Ù… Ø§Ù„Ø´Ø§Ø±Øª
          </button>
        </div>

        <div class="status-row">
          <div>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ Ø§Ù„Ø¢Ù†: <span id="live-price" style="color:var(--accent-strong);font-weight:600;">â€”</span></div>
          <div>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="last-update" style="color:var(--text-soft);">â€”</span></div>
        </div>

        <div class="auto-row">
          <label>
            <input type="checkbox" id="auto-refresh-checkbox" />
            ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù…ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©
          </label>
        </div>

        <div class="smart-banner" id="smart-banner">
          <div>
            <div class="smart-banner-title">
              <div class="smart-dot"></div>
              <span>SMART ALERTS: ON ğŸ””</span>
            </div>
            <div class="smart-msg" id="smart-msg">
              Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª...
            </div>
          </div>
          <button class="btn btn-secondary btn-xs" id="toggle-alerts-btn">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
        </div>
      </div>
    </section>

    <!-- Ø§Ù„Ø´Ø§Ø±Øª ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª -->
    <section class="card">
      <div class="card-inner">
        <div class="section-title">
          Ø§Ù„Ø´Ø§Ø±Øª Ø§Ù„Ø­ÙŠ
          <span>Ø´Ù…ÙˆØ¹ + EMA + RSI + ATR + Bollinger Bands</span>
        </div>

        <div id="chart-container"></div>

        <div class="indicator-row">
          <div class="chip">RSI(14): <strong id="rsi-val">â€”</strong></div>
          <div class="chip">EMA(9): <strong id="ema9-val">â€”</strong></div>
          <div class="chip">EMA(21): <strong id="ema21-val">â€”</strong></div>
          <div class="chip">ATR(14): <strong id="atr-val">â€”</strong></div>
          <div class="chip">BB% Width: <strong id="bb-width-val">â€”</strong></div>
        </div>

        <div class="advice-card">
          <div class="advice-header">
            <div style="font-weight:600;">Ù†ØµÙŠØ­Ø© Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬</div>
            <div class="advice-badges">
              <div class="badge" id="trend-badge">Ø¥ØªØ¬Ø§Ù‡: â€”</div>
              <div class="badge" id="regime-badge">ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙˆÙ‚: â€”</div>
              <div class="badge" id="signal-badge">Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø©: â€”</div>
            </div>
          </div>
          <div class="levels">
            <div class="level-item">
              <span class="level-label">Ø§Ù„Ø¯Ø®ÙˆÙ„:</span>
              <span class="level-value" id="entry-val">â€”</span>
            </div>
            <div class="level-item">
              <span class="level-label">SL:</span>
              <span class="level-value" id="sl-val">â€”</span>
            </div>
            <div class="level-item">
              <span class="level-label">TP1:</span>
              <span class="level-value" id="tp1-val">â€”</span>
            </div>
            <div class="level-item">
              <span class="level-label">TP2:</span>
              <span class="level-value" id="tp2-val">â€”</span>
            </div>
          </div>
          <div class="advice-reason" id="advice-reason">
            Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙˆØ¥Ù†ØªØ§Ø¬ Ù†ØµÙŠØ­Ø©...
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ================== Helpers ==================
    const $ = (id) => document.getElementById(id);

    const workerInput = $('worker-url');
    const limitInput = $('limit-input');
    const tfSelect = $('tf-select');
    const livePriceEl = $('live-price');
    const lastUpdateEl = $('last-update');
    const smartMsgEl = $('smart-msg');
    const trendBadge = $('trend-badge');
    const regimeBadge = $('regime-badge');
    const signalBadge = $('signal-badge');
    const entryVal = $('entry-val');
    const slVal = $('sl-val');
    const tp1Val = $('tp1-val');
    const tp2Val = $('tp2-val');
    const adviceReasonEl = $('advice-reason');

    const rsiVal = $('rsi-val');
    const ema9Val = $('ema9-val');
    const ema21Val = $('ema21-val');
    const atrVal = $('atr-val');
    const bbWidthVal = $('bb-width-val');

    const smartBanner = $('smart-banner');
    const toggleAlertsBtn = $('toggle-alerts-btn');
    const autoRefreshCheckbox = $('auto-refresh-checkbox');

    let smartAlertsOn = true;
    let autoRefreshTimer = null;

    // ================== Theme Toggle ==================
    const modeToggle = $('mode-toggle');
    modeToggle.addEventListener('click', () => {
      const mode = modeToggle.dataset.mode === 'dark' ? 'light' : 'dark';
      modeToggle.dataset.mode = mode;
      document.documentElement.style.background =
        mode === 'light'
          ? '#f3f4f6'
          : 'radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%)';
      document.body.style.background =
        mode === 'light'
          ? '#f3f4f6'
          : 'radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%)';
    });

    // ================== Chart Setup ==================
    const chartContainer = document.getElementById('chart-container');
    const chart = LightweightCharts.createChart(chartContainer, {
      layout: {
        background: { type: 'solid', color: '#020617' },
        textColor: '#e5e7eb',
      },
      grid: {
        vertLines: { color: '#111827' },
        horzLines: { color: '#111827' },
      },
      rightPriceScale: {
        borderVisible: false,
      },
      timeScale: {
        borderVisible: false,
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
      },
    });

    const candleSeries = chart.addCandlestickSeries({
      upColor: '#22c55e',
      downColor: '#ef4444',
      borderDownColor: '#ef4444',
      borderUpColor: '#22c55e',
      wickDownColor: '#ef4444',
      wickUpColor: '#22c55e',
    });

    const ema9Series = chart.addLineSeries({
      color: '#fbbf24',
      lineWidth: 2,
    });

    const ema21Series = chart.addLineSeries({
      color: '#60a5fa',
      lineWidth: 2,
    });

    // ================== Indicator Functions ==================
    function calcEMA(values, period) {
      const k = 2 / (period + 1);
      const ema = [];
      let prev;
      values.forEach((v, i) => {
        if (i === 0) {
          prev = v;
        } else {
          prev = v * k + prev * (1 - k);
        }
        ema.push(prev);
      });
      return ema;
    }

    function calcRSI(closes, period = 14) {
      if (closes.length < period + 1) return null;
      let gains = 0, losses = 0;
      for (let i = 1; i <= period; i++) {
        const diff = closes[i] - closes[i - 1];
        if (diff >= 0) gains += diff;
        else losses -= diff;
      }
      gains /= period;
      losses /= period;
      if (losses === 0) return 100;
      let rs = gains / losses;
      let rsi = 100 - (100 / (1 + rs));
      for (let i = period + 1; i < closes.length; i++) {
        const diff = closes[i] - closes[i - 1];
        const gain = diff >= 0 ? diff : 0;
        const loss = diff < 0 ? -diff : 0;
        gains = (gains * (period - 1) + gain) / period;
        losses = (losses * (period - 1) + loss) / period;
        if (losses === 0) rs = 0;
        else rs = gains / losses;
        rsi = 100 - (100 / (1 + rs));
      }
      return rsi;
    }

    function calcATR(bars, period = 14) {
      if (bars.length < period + 1) return null;
      const trs = [];
      for (let i = 1; i < bars.length; i++) {
        const cur = bars[i];
        const prev = bars[i - 1];
        const highLow = cur.h - cur.l;
        const highClose = Math.abs(cur.h - prev.c);
        const lowClose = Math.abs(cur.l - prev.c);
        const tr = Math.max(highLow, highClose, lowClose);
        trs.push(tr);
      }
      if (trs.length < period) return null;
      let atr = trs.slice(0, period).reduce((a, b) => a + b, 0) / period;
      for (let i = period; i < trs.length; i++) {
        atr = (atr * (period - 1) + trs[i]) / period;
      }
      return atr;
    }

    function calcBB(closes, period = 20, mult = 2) {
      if (closes.length < period) return null;
      const slice = closes.slice(-period);
      const mean = slice.reduce((a,b)=>a+b,0) / period;
      const variance = slice.reduce((a,b)=>a + (b-mean)*(b-mean),0) / period;
      const std = Math.sqrt(variance);
      const upper = mean + mult * std;
      const lower = mean - mult * std;
      return { upper, middle: mean, lower, width: (upper - lower) / mean };
    }

    function formatPrice(v) {
      return v == null || isNaN(v) ? 'â€”' : v.toFixed(2);
    }

    // ================== Fetch Live Price (Ù…Ù† /bars Ù†ÙØ³ Ø¯Ø§ØªØ§ Ø§Ù„Ø´Ù…ÙˆØ¹) ==================
    async function fetchLivePrice() {
      try {
        const url = (workerInput.value || '').trim();
        if (!url) {
          alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù€ Worker Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }
        const tf = tfSelect.value || '1m';
        const resp = await fetch(
          url.replace(/\/+$/,'') +
          `/bars?tf=${encodeURIComponent(tf)}&limit=1`
        );
        const bars = await resp.json();
        if (!Array.isArray(bars) || bars.length === 0 || bars[bars.length - 1].c == null) {
          throw new Error('no bars');
        }
        const lastBar = bars[bars.length - 1];
        livePriceEl.textContent = formatPrice(lastBar.c);
        lastUpdateEl.textContent = new Date().toLocaleTimeString('ar-LB');
      } catch (err) {
        console.error(err);
        livePriceEl.textContent = 'Ø®Ø·Ø£';
      }
    }

    // ================== Fetch Candles + Indicators ==================
    async function fetchCandlesAndRender() {
      try {
        const url = (workerInput.value || '').trim();
        if (!url) {
          alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù€ Worker Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }
        const tf = tfSelect.value;
        const limit = Number(limitInput.value) || 800;

        smartMsgEl.textContent = 'Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† Ø§Ù„ÙˆÙˆØ±ÙƒØ±...';
        smartMsgEl.style.color = '#e5e7eb';

        const resp = await fetch(
          url.replace(/\/+$/,'') + `/bars?tf=${encodeURIComponent(tf)}&limit=${limit}`
        );
        const bars = await resp.json();
        if (!Array.isArray(bars) || bars.length === 0) {
          smartMsgEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ù…ÙˆØ¹.';
          return;
        }

        // Convert to LightweightCharts format
        const candleData = bars.map(b => ({
          time: Math.floor(b.t / 1000),
          open: b.o,
          high: b.h,
          low:  b.l,
          close: b.c,
        }));
        candleSeries.setData(candleData);

        const closes = bars.map(b => b.c);
        const ema9 = calcEMA(closes, 9);
        const ema21 = calcEMA(closes, 21);
        const ema9SeriesData = candleData.map((c, i) => ema9[i] ? { time: c.time, value: ema9[i] } : null).filter(Boolean);
        const ema21SeriesData = candleData.map((c, i) => ema21[i] ? { time: c.time, value: ema21[i] } : null).filter(Boolean);
        ema9Series.setData(ema9SeriesData);
        ema21Series.setData(ema21SeriesData);

        const rsi = calcRSI(closes, 14);
        const atr = calcATR(bars, 14);
        const bb = calcBB(closes, 20, 2);

        rsiVal.textContent = rsi ? rsi.toFixed(1) : 'â€”';
        ema9Val.textContent = ema9.length ? ema9[ema9.length-1].toFixed(2) : 'â€”';
        ema21Val.textContent = ema21.length ? ema21[ema21.length-1].toFixed(2) : 'â€”';
        atrVal.textContent = atr ? atr.toFixed(2) : 'â€”';
        bbWidthVal.textContent = bb ? (bb.width*100).toFixed(1)+'%' : 'â€”';

        // === ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ Ù…Ù† Ø¢Ø®Ø± Ø´Ù…Ø¹Ø© (Ø±Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ø¯Ø§ØªØ§ D1/CSV) ===
        const lastClose = closes[closes.length-1];
        const prevClose = closes[closes.length-2] ?? lastClose;
        livePriceEl.textContent = formatPrice(lastClose);
        lastUpdateEl.textContent = new Date().toLocaleTimeString('ar-LB');

        // ===== Smart Alerts + Advice =====
        const emaFast = ema9[ema9.length-1];
        const emaSlow = ema21[ema21.length-1];

        let trend = 'Ø¬Ø§Ù†Ø¨ÙŠ';
        if (emaFast && emaSlow) {
          if (emaFast > emaSlow * 1.001) trend = 'ØµØ§Ø¹Ø¯';
          else if (emaFast < emaSlow * 0.999) trend = 'Ù‡Ø§Ø¨Ø·';
        }

        let regime = 'Ø­ÙŠØ§Ø¯ÙŠ';
        if (bb && bb.width < 0.004) regime = 'Ø§Ù†ÙØ¬Ø§Ø± Ù…Ø­ØªÙ…Ù„ (Squeeze)';
        else if (bb && bb.width > 0.018) regime = 'ØªØ°Ø¨Ø°Ø¨ Ø¹Ø§Ù„ÙŠ';

        let signal = 'Ø¨Ø¯ÙˆÙ†';
        let adviceSide = null;

        if (rsi && bb) {
          if ((rsi > 68 || lastClose > bb.upper) && trend !== 'ØµØ§Ø¹Ø¯') {
            signal = 'Ø¶ØºØ· Ø¨ÙŠØ¹ / ØªØ´Ø¨Ø¹ Ø´Ø±Ø§Ø¡';
            adviceSide = 'sell';
          } else if ((rsi < 32 || lastClose < bb.lower) && trend !== 'Ù‡Ø§Ø¨Ø·') {
            signal = 'Ø¶ØºØ· Ø´Ø±Ø§Ø¡ / ØªØ´Ø¨Ø¹ Ø¨ÙŠØ¹';
            adviceSide = 'buy';
          } else if (trend === 'ØµØ§Ø¹Ø¯') {
            signal = 'Ø´Ø±Ø§Ø¡ Ù…Ø¹ Ø§Ù„Ø§ØªØ¬Ø§Ù‡';
            adviceSide = 'buy';
          } else if (trend === 'Ù‡Ø§Ø¨Ø·') {
            signal = 'Ø¨ÙŠØ¹ Ù…Ø¹ Ø§Ù„Ø§ØªØ¬Ø§Ù‡';
            adviceSide = 'sell';
          }
        }

        const atrUse = atr || Math.max(1, lastClose * 0.0025);
        let entry = lastClose;
        let sl, tp1, tp2;

        if (adviceSide === 'buy') {
          sl = entry - 1.5 * atrUse;
          tp1 = entry + 2 * atrUse;
          tp2 = entry + 3 * atrUse;
        } else if (adviceSide === 'sell') {
          sl = entry + 1.5 * atrUse;
          tp1 = entry - 2 * atrUse;
          tp2 = entry - 3 * atrUse;
        }

        entryVal.textContent = adviceSide ? formatPrice(entry) : 'â€”';
        slVal.textContent    = sl ? formatPrice(sl) : 'â€”';
        tp1Val.textContent   = tp1 ? formatPrice(tp1) : 'â€”';
        tp2Val.textContent   = tp2 ? formatPrice(tp2) : 'â€”';

        trendBadge.textContent  = 'Ø¥ØªØ¬Ø§Ù‡: ' + trend;
        regimeBadge.textContent = 'ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙˆÙ‚: ' + regime;
        signalBadge.textContent = 'Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø©: ' + signal;

        if (smartAlertsOn) {
          if (!adviceSide) {
            smartMsgEl.textContent = 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ø¥Ø´Ø§Ø±Ø© Ù‚ÙˆÙŠØ©. ÙŠÙÙØ¶Ù‘Ù„ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.';
            smartMsgEl.style.color = '#e5e7eb';
          } else if (adviceSide === 'buy') {
            smartMsgEl.textContent = 'Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ù…Ø­ØªÙ…Ù„Ø© â€“ Ø±Ø§Ù‚Ø¨ Ø§Ø®ØªØ±Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ©.';
            smartMsgEl.style.color = '#bbf7d0';
          } else {
            smartMsgEl.textContent = 'Ø¥Ø´Ø§Ø±Ø© Ø¨ÙŠØ¹ Ù…Ø­ØªÙ…Ù„Ø© â€“ Ø±Ø§Ù‚Ø¨ ÙƒØ³Ø± Ø§Ù„Ø¯Ø¹ÙˆÙ… ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ©.';
            smartMsgEl.style.color = '#fecaca';
          }
        } else {
          smartMsgEl.textContent = 'Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© Ù…ØªÙˆÙ‚ÙØ© Ù…Ø¤Ù‚ØªØ§Ù‹.';
          smartMsgEl.style.color = '#9ca3af';
        }

        const dirText =
          adviceSide === 'buy'
            ? 'Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¯Ø®ÙˆÙ„ Ø´Ø±Ø§Ø¡ Ù…Ø¹ SL Ù…Ø­Ø§ÙØ¸ ØªØ­Øª Ø§Ù„Ù‚Ø§Ø¹ Ø§Ù„Ø£Ø®ÙŠØ±.'
            : adviceSide === 'sell'
              ? 'Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¯Ø®ÙˆÙ„ Ø¨ÙŠØ¹ Ù…Ø¹ SL Ù…Ø­Ø§ÙØ¸ ÙÙˆÙ‚ Ø§Ù„Ù‚Ù…Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©.'
              : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø© ÙˆØ§Ø¶Ø­Ø© â€“ Ø§Ù„Ø³ÙˆÙ‚ Ù…ØªØ°Ø¨Ø°Ø¨ Ø£Ùˆ Ø¨Ø¯ÙˆÙ† Ø§ØªØ¬Ø§Ù‡ Ù‚ÙˆÙŠ.';

        adviceReasonEl.innerHTML =
          `Ø§Ù„Ù…Ù„Ø®Øµ: <span>${signal}</span> Â· Ø§Ù„Ø¥ØªØ¬Ø§Ù‡: <span>${trend}</span> Â· ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙˆÙ‚: <span>${regime}</span>.<br>` +
          dirText + ` ÙŠÙÙØ¶Ù‘Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‚Ø±Ø§Ø± Ù…Ù† Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø¬ÙŠØ¯Ø§Ù‹.`;

      } catch (err) {
        console.error(err);
        smartMsgEl.textContent = 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙˆÙˆØ±ÙƒØ±.';
        smartMsgEl.style.color = '#fecaca';
      }
    }

    // ================== Smart Alerts Toggle ==================
    toggleAlertsBtn.addEventListener('click', () => {
      smartAlertsOn = !smartAlertsOn;
      toggleAlertsBtn.textContent = smartAlertsOn ? 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª' : 'ØªØ´ØºÙŠÙ„';
      if (!smartAlertsOn) {
        smartMsgEl.textContent = 'Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© Ù…ØªÙˆÙ‚ÙØ© Ù…Ø¤Ù‚ØªØ§Ù‹.';
        smartMsgEl.style.color = '#9ca3af';
      } else {
        smartMsgEl.textContent = 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª...';
        smartMsgEl.style.color = '#e5e7eb';
      }
    });

    // ================== Auto Refresh ==================
    autoRefreshCheckbox.addEventListener('change', () => {
      if (autoRefreshCheckbox.checked) {
        fetchCandlesAndRender();
        autoRefreshTimer = setInterval(fetchCandlesAndRender, 60_000);
      } else if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
      }
    });

    // ================== Persistence ==================
    const STORAGE_KEY = 'gsx_worker_url';
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) workerInput.value = saved;
    else workerInput.value = 'https://goldsignalsx-worker.samer-mourtada.workers.dev';

    $('save-url-btn').addEventListener('click', () => {
      const v = (workerInput.value || '').trim();
      if (!v) return;
      localStorage.setItem(STORAGE_KEY, v);
      alert('ØªÙ… Ø­ÙØ¸ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆÙˆØ±ÙƒØ± âœ…');
    });

    // ================== Button Events ==================
    $('live-price-btn').addEventListener('click', fetchLivePrice);
    $('load-candles-btn').addEventListener('click', fetchCandlesAndRender);

    // Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„
    window.addEventListener('load', () => {
      fetchLivePrice();
      fetchCandlesAndRender();
    });
  </script>
</body>
</html>
