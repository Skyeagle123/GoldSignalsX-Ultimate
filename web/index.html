<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>GoldSignalsX Â· Ultimate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root {
      --bg: #050811;
      --bg-card: #0c101b;
      --bg-card-soft: #151a28;
      --accent: #f4a623;
      --accent-soft: rgba(244,166,35,0.14);
      --accent-danger: #ff5370;
      --accent-success: #3ddc97;
      --text: #f9fafb;
      --text-soft: #9ca3af;
      --border: #1f2933;
      --green: #22c55e;
      --red: #ef4444;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #101427, #050811);
      color: var(--text);
      min-height: 100vh;
    }

    .page {
      max-width: 980px;
      margin: 0 auto;
      padding: 16px 12px 32px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 14px;
      border-radius: 18px;
      background: linear-gradient(135deg, #060917, #15192a);
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
      margin-bottom: 14px;
    }

    header .left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .moon-icon {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 30%, #f97316, #b45309);
      box-shadow: 0 0 20px rgba(249,115,22,0.4);
      font-size: 22px;
    }

    .title-block h1 {
      font-size: 18px;
      margin: 0;
    }
    .title-block small {
      display: block;
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .worker-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(34,197,94,0.1);
      font-size: 11px;
      color: var(--text-soft);
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent-danger);
      box-shadow: 0 0 0 0 rgba(34,197,94,0.7);
      transition: all .18s;
    }
    .dot.ok {
      background: var(--accent-success);
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.6); }
      70% { box-shadow: 0 0 0 8px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }

    .card {
      border-radius: 20px;
      background: var(--bg-card);
      padding: 14px 12px;
      border: 1px solid rgba(15,23,42,0.9);
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .field-row > * {
      flex: 1 1 140px;
    }

    .label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg-card-soft);
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    input::placeholder {
      color: #4b5563;
    }

    button {
      border: none;
      cursor: pointer;
      font-size: 13px;
    }

    .btn {
      border-radius: 999px;
      padding: 10px 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 500;
      white-space: nowrap;
    }

    .btn-main {
      background: linear-gradient(135deg, #fbbf24, #f97316);
      color: #111827;
      box-shadow: 0 14px 30px rgba(249,115,22,0.45);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-soft);
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 11px;
    }

    .flex {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .chip {
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-soft);
    }

    .chip strong { color: var(--text); }

    .switch {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-soft);
    }
    .switch input { accent-color: var(--accent); }

    .smart-banner {
      border-radius: 18px;
      padding: 10px 12px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: var(--accent-soft);
      color: var(--text);
      font-size: 12px;
    }
    .smart-banner.danger {
      background: rgba(248,113,113,0.16);
    }
    .smart-banner .title {
      font-weight: 600;
      font-size: 13px;
    }
    .smart-banner .note {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    #chart-container {
      margin-top: 10px;
      border-radius: 18px;
      overflow: hidden;
      background: #020617;
      border: 1px solid #111827;
      height: 380px;
      position: relative;
    }

    #chart {
      position: absolute;
      inset: 0;
    }

    .info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      font-size: 11px;
    }

    .pill {
      border-radius: 999px;
      padding: 5px 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid var(--border);
      color: var(--text-soft);
    }
    .pill span {
      color: var(--text);
      font-weight: 600;
      margin-right: 3px;
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .card {
        padding: 12px 10px;
      }
      #chart-container {
        height: 340px;
      }
    }
  </style>
</head>
<body>
  <div class="page">

    <header>
      <div class="left">
        <div class="moon-icon">ğŸŒ™</div>
        <div class="title-block">
          <h1>GoldSignalsX Â· Ultimate</h1>
          <small>+ Ø³Ø¹Ø± Ø­ÙŠ + Ø´Ù…ÙˆØ¹ ÙŠØ§Ø¨Ø§Ù†ÙŠØ© + Ù…Ø¤Ø´Ø±Ø§Øª (EMA, RSI, ATR, Bollinger Bands) + Ù†ØµÙŠØ­Ø© Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬</small>
        </div>
      </div>
      <div class="worker-status">
        <span>Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù€ Worker</span>
        <span class="dot" id="workerDot"></span>
      </div>
    </header>

    <!-- Ø§ØªØµØ§Ù„ Ø§Ù„ÙˆÙˆØ±ÙƒØ± -->
    <section class="card">
      <div class="card-header">
        <span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Â· Ø§Ø®ØªØ± Ø§Ù„Ù€ TF ÙˆØ§Ù„Ù€ Limit ÙˆØ§Ù„Ù€ Worker URL</span>
        <button id="btnSaveUrl" class="btn btn-small btn-outline">Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</button>
      </div>

      <div class="field-row">
        <div>
          <div class="label">Worker URL</div>
          <input id="workerUrl" type="text" placeholder="https://goldsignalsx-worker.samer-mourtada.workers.dev" />
        </div>
      </div>

      <div class="field-row">
        <div>
          <div class="label">TF</div>
          <select id="tfSelect">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m">15m</option>
            <option value="30m">30m</option>
            <option value="60m">1h</option>
            <option value="240m">4h</option>
            <option value="1d">ÙŠÙˆÙ…</option>
          </select>
        </div>
        <div>
          <div class="label">Limit</div>
          <input id="limitInput" type="number" min="100" max="3000" step="50" value="1200" />
        </div>
        <div class="flex" style="align-items:flex-end; justify-content:flex-end;">
          <button id="btnPrice" class="btn btn-main" style="min-width:150px;">
            ğŸ’² ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ
          </button>
        </div>
      </div>

      <div class="field-row">
        <div class="flex" style="flex:1;">
          <button id="btnFetchBars" class="btn btn-outline" style="flex:1;">
            ğŸ“Š Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ ÙˆØ±Ø³Ù… Ø§Ù„Ø´Ø§Ø±Øª
          </button>
        </div>
        <div class="flex-between" style="flex:2; flex-wrap:wrap;">
          <div class="chip">
            Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <strong id="lastUpdate">Ù€</strong>
          </div>
          <div class="chip">
            Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ Ø§Ù„Ø¢Ù†: <strong id="livePrice">Ù€</strong>
          </div>
          <div class="chip">
            Ø³Ø¹Ø± Ø¢Ø®Ø± Ø´Ù…Ø¹Ø©: <strong id="chartPrice">Ù€</strong>
          </div>
        </div>
      </div>

      <div class="flex-between" style="margin-top:4px;">
        <label class="switch">
          <input type="checkbox" id="autoCandles" />
          <span>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù…ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©</span>
        </label>
        <label class="switch">
          <input type="checkbox" id="autoPrice" checked />
          <span>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©</span>
        </label>
      </div>

      <div id="smartBanner" class="smart-banner">
        <div>
          <div class="title">SMART ALERTS: ON ğŸ””</div>
          <div class="note" id="smartText">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª...</div>
        </div>
        <div style="font-size:11px; color:var(--text-soft);">
          ÙŠÙ†ØµØ­ Ø¨ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø±ÙƒØ© Ù…Ù† Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù‚Ø¨Ù„ Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±.
        </div>
      </div>
    </section>

    <!-- Ø§Ù„Ø´Ø§Ø±Øª -->
    <section class="card">
      <div class="card-header">
        <span>Ø§Ù„Ø´Ø§Ø±Øª Ø§Ù„Ø­ÙŠ Â· Ø´Ù…ÙˆØ¹ + EMA + RSI + ATR + Bollinger Bands</span>
        <span style="font-size:11px;color:var(--text-soft);" id="dataInfo">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ø¨Ø¹Ø¯.</span>
      </div>

      <div id="chart-container">
        <div id="chart"></div>
      </div>

      <div class="info-row" id="indicatorRow">
        <div class="pill">RSI(14): <span id="rsiVal">Ù€</span></div>
        <div class="pill">ATR(14): <span id="atrVal">Ù€</span></div>
        <div class="pill">EMA(21): <span id="ema21Val">Ù€</span></div>
        <div class="pill">EMA(9): <span id="ema9Val">Ù€</span></div>
        <div class="pill">%BB Width: <span id="bbWidthVal">Ù€</span></div>
        <div class="pill">Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚: <span id="marketState">Ù€</span></div>
      </div>

      <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØµÙŠØ­Ø© -->
      <div class="card" style="background:var(--bg-card-soft); margin-top:10px;">
        <div class="card-header" style="margin-bottom:6px;">
          <span>Ø§Ù„Ù†ØµÙŠØ­Ø© Â· Ø¯Ø®ÙˆÙ„ / SL / TP</span>
          <span style="font-size:11px;color:var(--text-soft);">Ø­Ø³Ø§Ø¨ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ATR ÙˆØ§Ù„ØªØ±Ù†Ø¯</span>
        </div>
        <div class="info-row">
          <div class="pill">Ø§Ù„Ø¯Ø®ÙˆÙ„: <span id="adviceEntry">Ù€</span></div>
          <div class="pill">SL: <span id="adviceSL">Ù€</span></div>
          <div class="pill">TP1: <span id="adviceTP1">Ù€</span></div>
          <div class="pill">TP2: <span id="adviceTP2">Ù€</span></div>
        </div>
        <div style="margin-top:6px; font-size:11px; color:var(--text-soft);" id="adviceText">
          Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙƒØ«Ø± Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØµÙŠØ­Ø©.
        </div>
      </div>
    </section>

  </div>

  <script>
    // ==== Ø«ÙˆØ§Ø¨Øª Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù„ÙŠ ====
    const PRICE_INTERVAL_MS = 15000;   // 15 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ
    const CANDLES_INTERVAL_MS = 60000; // 60 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø´Ù…ÙˆØ¹

    // ====== Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ======
    const workerUrlInput = document.getElementById('workerUrl');
    const tfSelect = document.getElementById('tfSelect');
    const limitInput = document.getElementById('limitInput');
    const btnPrice = document.getElementById('btnPrice');
    const btnFetchBars = document.getElementById('btnFetchBars');
    const livePriceEl = document.getElementById('livePrice');
    const chartPriceEl = document.getElementById('chartPrice');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const smartBanner = document.getElementById('smartBanner');
    const smartText = document.getElementById('smartText');
    const dataInfo = document.getElementById('dataInfo');
    const workerDot = document.getElementById('workerDot');
    const btnSaveUrl = document.getElementById('btnSaveUrl');
    const autoCandles = document.getElementById('autoCandles');
    const autoPrice = document.getElementById('autoPrice');

    const rsiValEl = document.getElementById('rsiVal');
    const atrValEl = document.getElementById('atrVal');
    const ema21ValEl = document.getElementById('ema21Val');
    const ema9ValEl = document.getElementById('ema9Val');
    const bbWidthValEl = document.getElementById('bbWidthVal');
    const marketStateEl = document.getElementById('marketState');

    const adviceEntryEl = document.getElementById('adviceEntry');
    const adviceSLEl = document.getElementById('adviceSL');
    const adviceTP1El = document.getElementById('adviceTP1');
    const adviceTP2El = document.getElementById('adviceTP2');
    const adviceTextEl = document.getElementById('adviceText');

    // ====== ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø­Ù„ÙŠØ§Ù‹ ======
    const STORAGE_KEY_URL = 'gsx_worker_url';
    if (localStorage.getItem(STORAGE_KEY_URL)) {
      workerUrlInput.value = localStorage.getItem(STORAGE_KEY_URL);
    } else {
      workerUrlInput.value = 'https://goldsignalsx-worker.samer-mourtada.workers.dev';
    }
    btnSaveUrl.addEventListener('click', () => {
      localStorage.setItem(STORAGE_KEY_URL, workerUrlInput.value.trim());
      btnSaveUrl.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ”';
      setTimeout(() => btnSaveUrl.textContent = 'Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 1500);
    });

    // ====== Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ======
    function getBaseUrl() {
      return workerUrlInput.value.trim().replace(/\/+$/,'');
    }

    function setWorkerStatus(ok) {
      if (ok) workerDot.classList.add('ok');
      else workerDot.classList.remove('ok');
    }

    function fmt(num, digits = 2) {
      if (num == null || Number.isNaN(num)) return 'Ù€';
      return Number(num).toFixed(digits);
    }

    function nowLabel() {
      const d = new Date();
      return d.toLocaleTimeString('ar-LB', { hour12: false });
    }

    // ====== Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ======
    function ema(values, period) {
      const k = 2 / (period + 1);
      let emaPrev = values[0];
      const out = [emaPrev];
      for (let i = 1; i < values.length; i++) {
        emaPrev = values[i] * k + emaPrev * (1 - k);
        out.push(emaPrev);
      }
      return out;
    }

    function rsi(closes, period = 14) {
      if (closes.length <= period) return null;
      let gains = 0, losses = 0;
      for (let i = 1; i <= period; i++) {
        const diff = closes[i] - closes[i-1];
        if (diff >= 0) gains += diff; else losses -= diff;
      }
      let avgGain = gains / period;
      let avgLoss = losses / period;
      for (let i = period + 1; i < closes.length; i++) {
        const diff = closes[i] - closes[i-1];
        const gain = diff > 0 ? diff : 0;
        const loss = diff < 0 ? -diff : 0;
        avgGain = (avgGain * (period - 1) + gain) / period;
        avgLoss = (avgLoss * (period - 1) + loss) / period;
      }
      if (avgLoss === 0) return 100;
      const rs = avgGain / avgLoss;
      return 100 - 100 / (1 + rs);
    }

    function atr(bars, period = 14) {
      if (bars.length <= period + 1) return null;
      const trs = [];
      for (let i = 1; i < bars.length; i++) {
        const prevClose = bars[i-1].c;
        const hi = bars[i].h;
        const lo = bars[i].l;
        const tr = Math.max(
          hi - lo,
          Math.abs(hi - prevClose),
          Math.abs(lo - prevClose)
        );
        trs.push(tr);
      }
      let sum = 0;
      for (let i = 0; i < period; i++) sum += trs[i];
      let atrVal = sum / period;
      for (let i = period; i < trs.length; i++) {
        atrVal = (atrVal * (period - 1) + trs[i]) / period;
      }
      return atrVal;
    }

    function bollinger(closes, period = 20, stdMul = 2) {
      if (closes.length < period) return null;
      const slice = closes.slice(-period);
      const mean = slice.reduce((a,b)=>a+b,0) / period;
      const variance = slice.reduce((a,b)=>a + Math.pow(b-mean,2),0) / period;
      const std = Math.sqrt(variance);
      return {
        middle: mean,
        upper: mean + stdMul * std,
        lower: mean - stdMul * std,
        widthPercent: (stdMul*2*std) / mean * 100
      };
    }

    function analyzeMarket(lastClose, emaFast, emaSlow, rsiVal, bb) {
      if (lastClose == null || emaFast == null || emaSlow == null || rsiVal == null || !bb) {
        return {
          state: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          text: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙƒØ«Ø± Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª.',
          tone: 'neutral'
        };
      }

      const bullish = lastClose > emaFast && emaFast > emaSlow && rsiVal > 55;
      const bearish = lastClose < emaFast && emaFast < emaSlow && rsiVal < 45;
      const squeeze = bb.widthPercent < 3.5;

      if (bullish) {
        return {
          state: squeeze ? 'ØªØ±Ù†Ø¯ ØµØ§Ø¹Ø¯ Â· Ø§Ø®ØªÙ†Ø§Ù‚ BB' : 'ØªØ±Ù†Ø¯ ØµØ§Ø¹Ø¯',
          text: squeeze
            ? 'Ø§Ù„Ø³ÙˆÙ‚ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ø®ØªÙ†Ø§Ù‚ Ù…Ø¹ Ù…ÙŠÙ„ ØµØ§Ø¹Ø¯Ø› ÙŠÙ…ÙƒÙ† Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ø®ØªØ±Ø§Ù‚ Ù‚ÙˆÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹.'
            : 'Ø§Ù„ØªØ±Ù†Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ØµØ§Ø¹Ø¯Ø› ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙÙƒÙŠØ± Ø¨ØµÙÙ‚Ø§Øª Ø´Ø±Ø§Ø¡ Ø¨Ø¹Ø¯ ØªØ£ÙƒÙŠØ¯ Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„.',
          tone: 'bull'
        };
      } else if (bearish) {
        return {
          state: squeeze ? 'ØªØ±Ù†Ø¯ Ù‡Ø§Ø¨Ø· Â· Ø§Ø®ØªÙ†Ø§Ù‚ BB' : 'ØªØ±Ù†Ø¯ Ù‡Ø§Ø¨Ø·',
          text: squeeze
            ? 'Ø§Ù„Ø³ÙˆÙ‚ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ø®ØªÙ†Ø§Ù‚ Ù…Ø¹ Ù…ÙŠÙ„ Ù‡Ø§Ø¨Ø·Ø› ÙŠÙ…ÙƒÙ† Ù…Ø±Ø§Ù‚Ø¨Ø© ÙƒØ³Ø± Ù‚ÙˆÙŠ Ù„Ù„Ø£Ø³ÙÙ„.'
            : 'Ø§Ù„ØªØ±Ù†Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ø§Ø¨Ø·Ø› ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙÙƒÙŠØ± Ø¨ØµÙÙ‚Ø§Øª Ø¨ÙŠØ¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯.',
          tone: 'bear'
        };
      } else if (squeeze) {
        return {
          state: 'Ø±Ù†Ø¬ Ø¬Ø§Ù†Ø¨ÙŠ Â· Ø§Ø®ØªÙ†Ø§Ù‚ BB',
          text: 'Ø¨ÙˆÙ„Ù†Ø¬Ø± Ø¨Ø§Ù†Ù€Ø¯Ø² Ø¶ÙŠÙ‚Ø©Ø› Ø§Ù„Ø³ÙˆÙ‚ ÙÙŠ Ø­Ø§Ù„Ø© Ø±Ù†Ø¬ ÙˆÙ‚Ø¯ Ù†Ø´Ù‡Ø¯ Ø­Ø±ÙƒØ© Ù‚ÙˆÙŠØ© Ù‚Ø±ÙŠØ¨Ø§Ù‹.',
          tone: 'neutral'
        };
      }

      return {
        state: 'Ø±Ù†Ø¬ / Ø­ÙŠØ§Ø¯ÙŠ',
        text: 'Ø§Ù„Ø³ÙˆÙ‚ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¬Ø§Ù†Ø¨ÙŠØ› ÙŠÙÙØ¶Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø´Ø§Ø±Ø© Ø£ÙˆØ¶Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„.',
        tone: 'neutral'
      };
    }

    // ====== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ø§Ø±Øª ======
    const chartContainer = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartContainer, {
      layout: {
        background: { color: '#020617' },
        textColor: '#e5e7eb',
      },
      rightPriceScale: {
        borderColor: '#1f2937',
      },
      timeScale: {
        borderColor: '#1f2937',
      },
      grid: {
        vertLines: { color: '#111827' },
        horzLines: { color: '#111827' },
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
      },
      localization: {
        locale: 'en-US',
      }
    });

    const candleSeries = chart.addCandlestickSeries({
      upColor: '#22c55e',
      downColor: '#ef4444',
      borderUpColor: '#22c55e',
      borderDownColor: '#ef4444',
      wickUpColor: '#22c55e',
      wickDownColor: '#ef4444',
    });

    const ema21Series = chart.addLineSeries({
      color: '#fbbf24',
      lineWidth: 2,
    });

    const ema9Series = chart.addLineSeries({
      color: '#60a5fa',
      lineWidth: 1.8,
    });

    const bbUpper = chart.addLineSeries({
      color: '#a855f7',
      lineWidth: 1,
    });
    const bbLower = chart.addLineSeries({
      color: '#a855f7',
      lineWidth: 1,
    });

    let autoPriceTimer = null;
    let autoCandlesTimer = null;

    function resetIntervals() {
      if (autoPriceTimer) clearInterval(autoPriceTimer);
      if (autoCandlesTimer) clearInterval(autoCandlesTimer);

      if (autoPrice.checked) {
        autoPriceTimer = setInterval(fetchPrice, PRICE_INTERVAL_MS);
      }
      if (autoCandles.checked) {
        autoCandlesTimer = setInterval(fetchBarsAndDraw, CANDLES_INTERVAL_MS);
      }
    }

    autoPrice.addEventListener('change', resetIntervals);
    autoCandles.addEventListener('change', resetIntervals);

    // ====== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆÙˆØ±ÙƒØ± ======
    async function fetchPrice() {
      const base = getBaseUrl();
      if (!base) return;
      try {
        setWorkerStatus(true);
        const res = await fetch(base + '/price', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        livePriceEl.textContent = fmt(data.price, 2);
        lastUpdateEl.textContent = nowLabel();
      } catch (err) {
        console.error('PRICE ERROR', err);
        setWorkerStatus(false);
      }
    }

    async function fetchBarsAndDraw() {
      const base = getBaseUrl();
      if (!base) return;
      const tf = tfSelect.value;
      const limit = Number(limitInput.value || 800);

      try {
        setWorkerStatus(true);
        dataInfo.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

        const url = `${base}/bars?tf=${encodeURIComponent(tf)}&limit=${limit}`;
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const bars = await res.json();

        if (!Array.isArray(bars) || bars.length === 0) {
          dataInfo.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©.';
          smartText.textContent = 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„ÙˆÙˆØ±ÙƒØ±.';
          smartBanner.classList.remove('danger');
          return;
        }

        const chartBars = bars.map(b => ({
          time: Math.floor(b.t / 1000),
          open: b.o,
          high: b.h,
          low: b.l,
          close: b.c,
        }));

        candleSeries.setData(chartBars);

        const closes = bars.map(b => b.c);
        const ema21All = ema(closes, 21);
        const ema9All = ema(closes, 9);

        const ema21Data = chartBars.map((bar, i) => ({
          time: bar.time,
          value: ema21All[i],
        }));
        const ema9Data = chartBars.map((bar, i) => ({
          time: bar.time,
          value: ema9All[i],
        }));

        ema21Series.setData(ema21Data);
        ema9Series.setData(ema9Data);

        const bb = bollinger(closes, 20, 2);
        if (bb) {
          const bbUpperData = chartBars.map((bar, i) => ({
            time: bar.time,
            value: i >= chartBars.length - 20 ? bb.upper : null,
          })).filter(p => p.value != null);

          const bbLowerData = chartBars.map((bar, i) => ({
            time: bar.time,
            value: i >= chartBars.length - 20 ? bb.lower : null,
          })).filter(p => p.value != null);

          bbUpper.setData(bbUpperData);
          bbLower.setData(bbLowerData);
        }

        const rsiVal = rsi(closes, 14);
        const atrVal = atr(bars, 14);

        const lastClose = closes[closes.length - 1];
        const emaFast = ema9All[ema9All.length - 1];
        const emaSlow = ema21All[ema21All.length - 1];

        chartPriceEl.textContent = fmt(lastClose, 2);

        const analysis = analyzeMarket(lastClose, emaFast, emaSlow, rsiVal, bb);

        rsiValEl.textContent = fmt(rsiVal, 1);
        atrValEl.textContent = fmt(atrVal, 2);
        ema21ValEl.textContent = fmt(emaSlow, 2);
        ema9ValEl.textContent = fmt(emaFast, 2);
        bbWidthValEl.textContent = bb ? fmt(bb.widthPercent, 2) + '%' : 'Ù€';
        marketStateEl.textContent = analysis.state;

        smartText.textContent = analysis.text;
        if (analysis.tone === 'bull') {
          smartBanner.classList.remove('danger');
        } else if (analysis.tone === 'bear') {
          smartBanner.classList.add('danger');
        } else {
          smartBanner.classList.remove('danger');
        }

        dataInfo.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù…ÙˆØ¹: ${bars.length} Â· TF: ${tf}`;

        // ===== Ù†ØµÙŠØ­Ø© Ø¯Ø®ÙˆÙ„ / Ø®Ø±ÙˆØ¬ ØªÙ‚Ø±ÙŠØ¨ÙŠØ© =====
        if (atrVal && !Number.isNaN(atrVal) && (analysis.tone === 'bull' || analysis.tone === 'bear')) {
          const dir = analysis.tone === 'bull' ? 1 : -1;
          const entry = lastClose;
          const sl = entry - dir * 1.5 * atrVal;   // 1.5 ATR
          const tp1 = entry + dir * 1.5 * atrVal;  // 1.5 ATR
          const tp2 = entry + dir * 3 * atrVal;    // 3 ATR

          adviceEntryEl.textContent = fmt(entry, 2);
          adviceSLEl.textContent = fmt(sl, 2);
          adviceTP1El.textContent = fmt(tp1, 2);
          adviceTP2El.textContent = fmt(tp2, 2);
          adviceTextEl.textContent = analysis.tone === 'bull'
            ? 'Ù†Ù…ÙˆØ°Ø¬ Ø¯Ø®ÙˆÙ„ Ø´Ø±Ø§Ø¡ ØªÙ‚Ø±ÙŠØ¨ÙŠØ› ÙŠÙÙØ¶Ù„ Ø£Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© 1â€“2% Ù…Ù† Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„.'
            : 'Ù†Ù…ÙˆØ°Ø¬ Ø¯Ø®ÙˆÙ„ Ø¨ÙŠØ¹ ØªÙ‚Ø±ÙŠØ¨ÙŠØ› ÙŠÙÙØ¶Ù„ Ø£Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© 1â€“2% Ù…Ù† Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„.';
        } else {
          adviceEntryEl.textContent =
            adviceSLEl.textContent =
            adviceTP1El.textContent =
            adviceTP2El.textContent = 'Ù€';
          adviceTextEl.textContent = 'Ø§Ù„Ø³ÙˆÙ‚ ØºÙŠØ± ÙˆØ§Ø¶Ø­ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©Ø› Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµÙŠØ­Ø© Ù…Ø¤ÙƒØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.';
        }

      } catch (err) {
        console.error('BARS ERROR', err);
        setWorkerStatus(false);
        dataInfo.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† Ø§Ù„ÙˆÙˆØ±ÙƒØ±.';
        smartText.textContent = 'ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹Ø› ØªØ­Ù‚Ù‚ Ù…Ù† Worker URL Ø£Ùˆ Ø¬Ø±Ù‘Ø¨ Ù„Ø§Ø­Ù‚Ø§Ù‹.';
        smartBanner.classList.add('danger');
      }
    }

    // ====== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø± ======
    btnPrice.addEventListener('click', fetchPrice);
    btnFetchBars.addEventListener('click', fetchBarsAndDraw);

    // ====== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ======
    fetchPrice();
    fetchBarsAndDraw();
    resetIntervals();

    window.addEventListener('resize', () => {
      chart.applyOptions({ width: chartContainer.clientWidth });
    });
    chart.applyOptions({ width: chartContainer.clientWidth });
  </script>
</body>
</html>
