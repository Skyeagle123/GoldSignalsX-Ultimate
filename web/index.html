<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoldSignalsX â€¢ Ultimate</title>

  <!-- Ø®Ø· -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --bg-soft: #020617;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #fbbf24;
      --accent-soft: rgba(251, 191, 36, 0.14);
      --border-subtle: rgba(148, 163, 184, 0.35);
      --chip-bg: rgba(15, 23, 42, 0.9);
      --danger: #f97373;
      --success: #22c55e;
    }
    .light {
      --bg: #f9fafb;
      --bg-card: #ffffff;
      --bg-soft: #e5e7eb;
      --text: #0f172a;
      --text-muted: #6b7280;
      --accent: #ea580c;
      --accent-soft: rgba(234, 88, 12, 0.08);
      --border-subtle: rgba(148, 163, 184, 0.6);
      --chip-bg: #f3f4f6;
      --danger: #dc2626;
      --success: #16a34a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Cairo", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }
    body.light {
      background: radial-gradient(circle at top, #e5e7eb 0, #f9fafb 40%, #e5e7eb 100%);
    }

    .app {
      width: 100%;
      max-width: 480px;
      margin: auto;
    }
    .card {
      background: var(--bg-card);
      border-radius: 22px;
      padding: 18px 16px 16px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
    }

    .top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .title {
      font-size: 18px;
      font-weight: 700;
    }
    .subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 13px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.16s ease;
      white-space: nowrap;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }
    .btn-ghost:hover {
      background: rgba(148, 163, 184, 0.1);
    }

    .btn-primary {
      background: linear-gradient(135deg, #fbbf24, #f97316);
      color: #111827;
      box-shadow: 0 10px 25px rgba(249, 115, 22, 0.4);
    }
    .btn-primary:active { transform: translateY(1px); }

    .btn-secondary {
      background: var(--chip-bg);
      color: var(--text);
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    label {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 3px;
    }

    .input, select {
      width: 100%;
      padding: 9px 11px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      color: var(--text);
      font-size: 12px;
      outline: none;
    }
    body.light .input, body.light select {
      background: #f9fafb;
    }
    .input::placeholder {
      color: var(--text-muted);
    }
    select {
      appearance: none;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--chip-bg);
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 11px;
      color: var(--text-muted);
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger);
    }
    .dot.ok { background: var(--success); }

    .panel {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 16px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
    }
    .price-val {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }
    .advice-text {
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: var(--chip-bg);
      color: var(--text-muted);
    }

    #chart-wrap {
      margin-top: 10px;
      border-radius: 18px;
      background: #020617;
      border: 1px solid rgba(30, 64, 175, 0.8);
      padding: 6px;
      height: 340px;
      position: relative;
    }
    body.light #chart-wrap {
      background: #f9fafb;
      border-color: rgba(59, 130, 246, 0.8);
    }
    #chart {
      width: 100%;
      height: 100%;
    }
    #chart-msg {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      pointer-events: none;
      padding: 16px;
    }

    .indicators-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 10px;
      color: var(--text-muted);
    }
    .ind-chip {
      padding: 4px 7px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }
    .ind-chip strong {
      color: var(--accent);
      margin-inline-start: 3px;
    }

    .footer {
      margin-top: 10px;
      font-size: 10px;
      text-align: center;
      color: var(--text-muted);
    }

    .btn-alert-on {
      background: #16a34a;
      color: #ecfdf5;
    }
    .btn-alert-off {
      background: #111827;
      color: #e5e7eb;
    }
    body.light .btn-alert-off {
      background: #e5e7eb;
      color: #111827;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="top-row">
        <div>
          <div class="title">GoldSignalsX â€¢ Ultimate</div>
          <div class="subtitle">Ø³Ø¹Ø± Ø­ÙŠ + Ø´Ù…ÙˆØ¹ + Ù…Ø¤Ø´Ø±Ø§Øª + Ù†ØµØ§Ø¦Ø­ + ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø°ÙƒÙŠØ©</div>
        </div>
        <button id="theme-toggle" class="btn btn-ghost" type="button">
          ğŸŒ™ Ø¯Ø§ÙƒÙ†
        </button>
      </div>

      <div class="row" style="justify-content:space-between;margin-bottom:6px;">
        <div class="pill">
          <span id="worker-dot" class="dot"></span>
          <span id="worker-status">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ù€ Workerâ€¦</span>
        </div>
        <div class="pill">
          <span style="font-size:10px;color:var(--text-muted);">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</span>
          <span id="last-update" style="font-size:11px;">â€”</span>
        </div>
      </div>

      <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
      <div class="row">
        <div style="flex:1;min-width:0;">
          <label for="worker-url">Worker URL</label>
          <input id="worker-url" class="input"
                 placeholder="https://goldsignalsx-worker.samer-mourtada.workers.dev" />
        </div>
      </div>
      <div class="row">
        <div style="flex:1;min-width:0;">
          <label for="tf">TF</label>
          <select id="tf" class="input">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m">15m</option>
            <option value="30m">30m</option>
            <option value="60m">60m</option>
            <option value="240m">4h</option>
            <option value="1d">1d</option>
          </select>
        </div>
        <div style="width:110px;">
          <label for="limit">Limit</label>
          <input id="limit" class="input" type="number" min="100" max="5000" value="800" />
        </div>
      </div>

      <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
      <div class="row">
        <button id="btn-price" type="button" class="btn btn-primary" style="flex:1;">
          ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ ğŸ’²
        </button>
        <button id="btn-bars" type="button" class="btn btn-secondary" style="flex:1;">
          Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ ÙˆØ±Ø³Ù… Ø§Ù„Ø´Ø§Ø±Øª ğŸ“Š
        </button>
      </div>

      <!-- Ø§Ù„Ø³Ø¹Ø± + Ø²Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª + Ø§Ù„Ù†ØµÙŠØ­Ø© -->
      <div class="panel">
        <div style="display:flex;flex-direction:column;gap:2px;">
          <div style="font-size:11px;color:var(--text-muted);">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ Ø§Ù„Ø¢Ù†</div>
          <div class="price-val" id="live-price">â€”</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;">
          <button id="btn-alerts" class="btn btn-alert-on" type="button" style="font-size:11px;padding-inline:10px;">
            ğŸ”” SMART ALERTS: ON
          </button>
          <div class="advice-text" id="advice-text">
            Ù†ØµÙŠØ­Ø©: Ø§Ù†ØªØ¸Ø± Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„.
          </div>
        </div>
      </div>

      <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚ / Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª -->
      <div class="row" style="margin-top:8px;">
        <span class="badge" id="market-mode-badge">Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚: â€”</span>
        <span class="badge" id="signal-badge">Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø©: â€”</span>
      </div>

      <!-- Ø§Ù„Ø´Ø§Ø±Øª -->
      <div id="chart-wrap">
        <div id="chart"></div>
        <div id="chart-msg">Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† Ø§Ù„Ù€ Workerâ€¦</div>
      </div>

      <!-- Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª -->
      <div class="indicators-row" id="indicators-row">
        <div class="ind-chip">EMA(9): <strong id="ema-fast-val">â€”</strong></div>
        <div class="ind-chip">EMA(21): <strong id="ema-slow-val">â€”</strong></div>
        <div class="ind-chip">RSI(14): <strong id="rsi-val">â€”</strong></div>
        <div class="ind-chip">MACD: <strong id="macd-val">â€”</strong></div>
        <div class="ind-chip">Stoch: <strong id="stoch-val">â€”</strong></div>
        <div class="ind-chip">ATR(14): <strong id="atr-val">â€”</strong></div>
        <div class="ind-chip">BB(20): <strong id="bb-width-val">â€”</strong></div>
      </div>

      <div class="footer">
        GoldSignalsX â€¢ Ultimate â€” Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† Ø§Ù„Ù€ Worker â€” Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­.
      </div>
    </div>
  </div>

  <script>
    (function(){
      const DEFAULT_WORKER = "https://goldsignalsx-worker.samer-mourtada.workers.dev";

      // Ø¹Ù†Ø§ØµØ± DOM
      const workerUrlInput = document.getElementById("worker-url");
      const tfSelect       = document.getElementById("tf");
      const limitInput     = document.getElementById("limit");
      const btnPrice       = document.getElementById("btn-price");
      const btnBars        = document.getElementById("btn-bars");
      const livePriceSpan  = document.getElementById("live-price");
      const workerDot      = document.getElementById("worker-dot");
      const workerStatus   = document.getElementById("worker-status");
      const lastUpdateSpan = document.getElementById("last-update");
      const chartMsg       = document.getElementById("chart-msg");
      const themeToggle    = document.getElementById("theme-toggle");
      const adviceText     = document.getElementById("advice-text");
      const marketModeBadge = document.getElementById("market-mode-badge");
      const signalBadge    = document.getElementById("signal-badge");
      const btnAlerts      = document.getElementById("btn-alerts");

      const emaFastSpan = document.getElementById("ema-fast-val");
      const emaSlowSpan = document.getElementById("ema-slow-val");
      const rsiSpan     = document.getElementById("rsi-val");
      const macdSpan    = document.getElementById("macd-val");
      const stochSpan   = document.getElementById("stoch-val");
      const atrSpan     = document.getElementById("atr-val");
      const bbSpan      = document.getElementById("bb-width-val");

      // Theme
      function setTheme(mode){
        if(mode === "light"){
          document.body.classList.add("light");
          themeToggle.textContent = "â˜€ï¸ ÙØ§ØªØ­";
        } else {
          document.body.classList.remove("light");
          themeToggle.textContent = "ğŸŒ™ Ø¯Ø§ÙƒÙ†";
        }
        localStorage.setItem("gsx-theme", mode);
      }
      const storedTheme = localStorage.getItem("gsx-theme");
      if(storedTheme === "light" || storedTheme === "dark"){
        setTheme(storedTheme);
      } else {
        setTheme("dark");
      }
      themeToggle.addEventListener("click", () => {
        const current = document.body.classList.contains("light") ? "light" : "dark";
        setTheme(current === "light" ? "dark" : "light");
      });

      // Alerts
      let alertsOn = true;
      function updateAlertsButton(){
        if(alertsOn){
          btnAlerts.classList.add("btn-alert-on");
          btnAlerts.classList.remove("btn-alert-off");
          btnAlerts.textContent = "ğŸ”” SMART ALERTS: ON";
        } else {
          btnAlerts.classList.remove("btn-alert-on");
          btnAlerts.classList.add("btn-alert-off");
          btnAlerts.textContent = "ğŸ”• SMART ALERTS: OFF";
        }
      }
      btnAlerts.addEventListener("click", () => {
        alertsOn = !alertsOn;
        updateAlertsButton();
      });
      updateAlertsButton();

      function playAlertSound(){
        if(!alertsOn) return;
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = "sine";
          osc.frequency.value = 900;
          osc.connect(gain);
          gain.connect(ctx.destination);
          gain.gain.setValueAtTime(0.2, ctx.currentTime);
          osc.start();
          osc.stop(ctx.currentTime + 0.18);
        } catch(e) {
          console.warn("Audio error", e);
        }
      }

      function getBase(){
        let v = (workerUrlInput.value || "").trim();
        if(!v) v = DEFAULT_WORKER;
        v = v.replace(/\/+$/g, "");
        return v;
      }

      async function pingWorker(){
        try {
          const r = await fetch(getBase() + "/health", { cache: "no-store" });
          if(r.ok){
            workerDot.classList.add("ok");
            workerStatus.textContent = "Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù€ Worker";
          } else {
            workerDot.classList.remove("ok");
            workerStatus.textContent = "Ù…Ø´ÙƒÙ„Ø© ÙÙŠ /health (" + r.status + ")";
          }
        } catch(e){
          workerDot.classList.remove("ok");
          workerStatus.textContent = "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ Worker";
        }
      }

      function touchTime(){
        const d = new Date();
        lastUpdateSpan.textContent = d.toLocaleTimeString("en-GB", {hour12:false});
      }

      async function fetchJSON(path){
        const url = getBase() + path;
        const r = await fetch(url, { cache:"no-store", headers:{accept:"application/json"} });
        if(!r.ok) throw new Error("HTTP " + r.status + " for " + path);
        return await r.json();
      }

      // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­ÙŠ
      async function updatePrice(){
        btnPrice.disabled = true;
        try{
          const j = await fetchJSON("/price");
          if(j && j.ok && Number.isFinite(j.price)){
            livePriceSpan.textContent = j.price.toFixed(2);
            touchTime();
            workerDot.classList.add("ok");
            workerStatus.textContent = j.source
              ? "Ø§Ù„Ù…ØµØ¯Ø±: " + j.source
              : "Ø§Ù„Ù…ØµØ¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
          } else {
            livePriceSpan.textContent = "ERR";
          }
        }catch(e){
          console.error("price error", e);
          livePriceSpan.textContent = "ERR";
          workerDot.classList.remove("ok");
          workerStatus.textContent = "ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø±";
        }finally{
          btnPrice.disabled = false;
        }
      }

      // Ø§Ù„Ø´Ø§Ø±Øª + Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
      let chart = null;
      let candleSeries = null;

      function ensureChart(){
        if(chart) return;
        chart = LightweightCharts.createChart(document.getElementById("chart"), {
          layout:{
            background:{type:"solid", color: getComputedStyle(document.body).getPropertyValue("--bg").trim() || "#020617"},
            textColor: getComputedStyle(document.body).getPropertyValue("--text").trim() || "#e5e7eb"
          },
          grid:{
            vertLines:{color:"rgba(148,163,184,0.18)"},
            horzLines:{color:"rgba(148,163,184,0.18)"}
          },
          rightPriceScale:{borderColor:"rgba(148,163,184,0.45)"},
          timeScale:{borderColor:"rgba(148,163,184,0.45)", timeVisible:true, secondsVisible:false},
          crosshair:{mode: LightweightCharts.CrosshairMode.Normal}
        });
        candleSeries = chart.addCandlestickSeries({
          upColor:"#22c55e", downColor:"#ef4444",
          wickUpColor:"#22c55e", wickDownColor:"#ef4444",
          borderVisible:false
        });
      }

      function ema(values, period){
        const k = 2 / (period + 1);
        let emaArr = [];
        let sum = 0;
        for(let i=0;i<values.length;i++){
          const v = values[i];
          if(i < period){
            sum += v;
            if(i === period-1){
              emaArr.push(sum/period);
            } else {
              emaArr.push(null);
            }
          } else {
            const prev = emaArr[i-1] ?? v;
            emaArr.push(v * k + prev * (1-k));
          }
        }
        return emaArr;
      }

      function rsi(values, period){
        let out = [];
        let gains=0, losses=0;
        for(let i=0;i<values.length;i++){
          if(i===0){ out.push(null); continue; }
          const diff = values[i] - values[i-1];
          const gain = diff > 0 ? diff : 0;
          const loss = diff < 0 ? -diff : 0;
          if(i <= period){
            gains += gain;
            losses += loss;
            if(i===period){
              const avgG = gains/period;
              const avgL = losses/period || 1e-9;
              const rs = avgG/avgL;
              out.push(100 - 100/(1+rs));
            } else {
              out.push(null);
            }
          } else {
            const prev = out[out.length-1];
            const prevG = ((prev != null) ? null : null); // not used
            // EMA style
            const avgG = ((out[i-1] != null) ? null : null); // not used
            gains = (gains*(period-1) + gain)/period;
            losses = (losses*(period-1) + loss)/period || 1e-9;
            const rs = gains/losses;
            out.push(100 - 100/(1+rs));
          }
        }
        return out;
      }

      function rsiSimple(values, period){
        let out = [];
        let gains=0, losses=0;
        for(let i=0;i<values.length;i++){
          if(i===0){ out.push(null); continue; }
          const diff = values[i] - values[i-1];
          const gain = diff > 0 ? diff : 0;
          const loss = diff < 0 ? -diff : 0;
          if(i <= period){
            gains += gain;
            losses += loss;
            if(i===period){
              const avgG = gains/period;
              const avgL = losses/period || 1e-9;
              const rs = avgG/avgL;
              out.push(100 - 100/(1+rs));
            } else {
              out.push(null);
            }
          } else {
            gains = (gains*(period-1) + gain)/period;
            losses = (losses*(period-1) + loss)/period || 1e-9;
            const rs = gains/losses;
            out.push(100 - 100/(1+rs));
          }
        }
        return out;
      }

      function macd(values, fast=12, slow=26, signal=9){
        const emaFast = ema(values, fast);
        const emaSlow = ema(values, slow);
        const macdLine = values.map((_,i)=>{
          if(emaFast[i]==null || emaSlow[i]==null) return null;
          return emaFast[i] - emaSlow[i];
        });
        const signalLine = ema(macdLine.map(v=>v==null?0:v), signal);
        const hist = macdLine.map((v,i)=>{
          if(v==null || signalLine[i]==null) return null;
          return v - signalLine[i];
        });
        return { macdLine, signalLine, hist };
      }

      function stochastic(highs, lows, closes, period=14){
        const out = [];
        for(let i=0;i<closes.length;i++){
          if(i < period-1){ out.push(null); continue; }
          let h = -Infinity, l = Infinity;
          for(let j=i-period+1;j<=i;j++){
            if(highs[j]>h) h=highs[j];
            if(lows[j]<l)  l=lows[j];
          }
          const c = closes[i];
          const denom = (h-l) || 1e-9;
          out.push(((c-l)/denom)*100);
        }
        return out;
      }

      function atr(highs, lows, closes, period=14){
        const trs = [];
        for(let i=0;i<closes.length;i++){
          if(i===0){
            trs.push(highs[i]-lows[i]);
          } else {
            const prevC = closes[i-1];
            const tr = Math.max(
              highs[i]-lows[i],
              Math.abs(highs[i]-prevC),
              Math.abs(lows[i]-prevC)
            );
            trs.push(tr);
          }
        }
        const out = [];
        let sum = 0;
        for(let i=0;i<trs.length;i++){
          const v = trs[i];
          if(i<period){
            sum += v;
            if(i===period-1){
              out.push(sum/period);
            } else {
              out.push(null);
            }
          } else {
            const prev = out[i-1] ?? v;
            const cur = (prev*(period-1)+v)/period;
            out.push(cur);
          }
        }
        return out;
      }

      function bollinger(values, period=20, mult=2){
        const out = [];
        for(let i=0;i<values.length;i++){
          if(i<period-1){ out.push({mid:null, upper:null, lower:null, width:null}); continue; }
          let sum = 0;
          for(let j=i-period+1;j<=i;j++) sum += values[j];
          const mean = sum/period;
          let varSum = 0;
          for(let j=i-period+1;j<=i;j++){
            const d = values[j]-mean;
            varSum += d*d;
          }
          const stdev = Math.sqrt(varSum/period);
          const upper = mean + mult*stdev;
          const lower = mean - mult*stdev;
          out.push({ mid:mean, upper, lower, width:(upper-lower) });
        }
        return out;
      }

      function detectPattern(prev, cur){
        if(!prev || !cur) return null;
        const body = cur.close - cur.open;
        const range = cur.high - cur.low;
        if(range === 0) return null;
        const rb = Math.abs(body)/range;
        const upperShadow = cur.high - Math.max(cur.close, cur.open);
        const lowerShadow = Math.min(cur.close, cur.open) - cur.low;
        const us = upperShadow/range;
        const ls = lowerShadow/range;

        // Doji
        if(rb < 0.1) return "ï¼‹";

        // Hammer / Hanging
        if(ls > 0.55 && us < 0.2){
          if(cur.close > cur.open) return "ğŸ”¨";
          return "ğŸª“";
        }

        // Shooting star
        if(us > 0.55 && ls < 0.2){
          return "â­";
        }

        // Engulfing
        const prevBody = prev.close - prev.open;
        if(prevBody<0 && body>0 && cur.close>prev.open && cur.open<prev.close){
          return "ğŸŸ¢E";
        }
        if(prevBody>0 && body<0 && cur.close<prev.open && cur.open>prev.close){
          return "ğŸ”´E";
        }

        return null;
      }

      function analyzeMarket(bars){
        if(bars.length<30) return { mode:"ØºÙŠØ± ÙƒØ§ÙÙŠØ©", modeRaw:"none" };
        const closes = bars.map(b=>b.close);
        const ema20 = ema(closes, 20);
        const last = ema20[ema20.length-1];
        const prev = ema20[ema20.length-6];
        if(last==null || prev==null) return { mode:"ØºÙŠØ± ÙˆØ§Ø¶Ø­", modeRaw:"none" };
        const slope = (last-prev)/prev;
        if(Math.abs(slope) < 0.0015){
          return { mode:"Ø±Ù†Ø¬ / Ø¬Ø§Ù†Ø¨ÙŠ", modeRaw:"range" };
        } else if(slope > 0){
          return { mode:"ØªØ±Ù†Ø¯ ØµØ§Ø¹Ø¯", modeRaw:"uptrend" };
        } else {
          return { mode:"ØªØ±Ù†Ø¯ Ù‡Ø§Ø¨Ø·", modeRaw:"downtrend" };
        }
      }

      function buildSignals(bars){
        if(!bars || bars.length<30) return null;
        const closes = bars.map(b=>b.close);
        const highs  = bars.map(b=>b.high);
        const lows   = bars.map(b=>b.low);

        const emaFast = ema(closes, 9);
        const emaSlow = ema(closes, 21);
        const rsiVals = rsiSimple(closes, 14);
        const macdObj = macd(closes);
        const stochVals = stochastic(highs, lows, closes, 14);
        const atrVals = atr(highs, lows, closes, 14);
        const bbVals = bollinger(closes, 20, 2);

        const i = closes.length-1;
        const last = {
          emaFast: emaFast[i],
          emaSlow: emaSlow[i],
          rsi: rsiVals[i],
          macd: macdObj.macdLine[i],
          stoch: stochVals[i],
          atr: atrVals[i],
          bb: bbVals[i]
        };

        const prevBar = bars[bars.length-2];
        const curBar  = bars[bars.length-1];
        const pattern = detectPattern(prevBar, curBar);

        const modeInfo = analyzeMarket(bars);

        let signal = null;
        let text   = "Ø§Ù†ØªØ¸Ø± ÙˆØ¶ÙˆØ­ Ø£ÙƒØ«Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
        let strength = "neutral";

        // Ø¥Ø´Ø§Ø±Ø§Øª RSI
        if(last.rsi != null){
          if(last.rsi > 70){
            signal = "RSI Overbought";
            text = "RSI ÙÙˆÙ‚ 70 â†’ Ø§Ù„Ø³ÙˆÙ‚ Ù…Ø´Ø¨Ø¹ Ø´Ø±Ø§Ø¡ØŒ ÙÙƒØ± Ø¨Ø¬Ù†ÙŠ Ø£Ø±Ø¨Ø§Ø­ Ø£Ùˆ ØªØ­Ø±ÙŠÙƒ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©.";
            strength = "warn-sell";
          } else if(last.rsi < 30){
            signal = "RSI Oversold";
            text = "RSI ØªØ­Øª 30 â†’ Ø§Ù„Ø³ÙˆÙ‚ Ù…Ø´Ø¨Ø¹ Ø¨ÙŠØ¹ØŒ Ø±Ø§Ù‚Ø¨ Ø´Ù…Ø¹Ø© Ø§Ù†Ø¹ÙƒØ§Ø³ÙŠØ© Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø´Ø±Ø§Ø¡.";
            strength = "warn-buy";
          }
        }

        // Ù†Ù…Ùˆ ØªØ±Ù†Ø¯ + ØªÙ‚Ø§Ø·Ø¹ EMA
        if(last.emaFast != null && last.emaSlow != null){
          if(last.emaFast > last.emaSlow * 1.002 && curBar.close > last.emaFast){
            signal = "BUY TREND";
            text = "ØªÙ‚Ø§Ø·Ø¹ EMA ØµØ§Ø¹Ø¯ ÙˆØ§Ù„Ø³Ø¹Ø± ÙÙˆÙ‚ Ø§Ù„Ù…ØªÙˆØ³Ø· â†’ ÙØ±ØµØ© Ø´Ø±Ø§Ø¡ Ù…Ø¹ Ø§Ù„ØªØ±Ù†Ø¯.";
            strength = "buy";
          } else if(last.emaFast < last.emaSlow * 0.998 && curBar.close < last.emaFast){
            signal = "SELL TREND";
            text = "ØªÙ‚Ø§Ø·Ø¹ EMA Ù‡Ø§Ø¨Ø· ÙˆØ§Ù„Ø³Ø¹Ø± ØªØ­Øª Ø§Ù„Ù…ØªÙˆØ³Ø· â†’ ÙØ±ØµØ© Ø¨ÙŠØ¹ Ù…Ø¹ Ø§Ù„ØªØ±Ù†Ø¯.";
            strength = "sell";
          }
        }

        // Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ù…ÙˆØ¹ Ø§Ù„Ù‚ÙˆÙŠØ©
        if(pattern === "ğŸ”¨" || pattern === "ğŸŸ¢E"){
          signal = "BUY STRONG";
          text = "Ù†Ù…Ø· Ø´Ù…Ø¹Ø© Ø§Ù†Ø¹ÙƒØ§Ø³ÙŠØ© Ø´Ø±Ø§Ø¦ÙŠØ© Ù‚ÙˆÙŠ (Hammer / Engulfing). Ø±Ø§Ù‚Ø¨ ØªØ£ÙƒÙŠØ¯ ÙÙŠ Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©.";
          strength = "buy-strong";
        } else if(pattern === "â­" || pattern === "ğŸ”´E"){
          signal = "SELL STRONG";
          text = "Ù†Ù…Ø· Ø´Ù…Ø¹Ø© Ø§Ù†Ø¹ÙƒØ§Ø³ÙŠØ© Ø¨ÙŠØ¹ÙŠØ© Ù‚ÙˆÙŠ (Shooting Star / Engulfing). Ø±Ø§Ù‚Ø¨ ÙƒØ³Ø± Ù‚Ø§Ø¹ Ø§Ù„Ø´Ù…Ø¹Ø©.";
          strength = "sell-strong";
        }

        // BB
        if(last.bb && last.bb.width != null && last.bb.width > 0){
          const ww = last.bb.width/curBar.close;
          if(ww < 0.01 && !signal){
            signal = "BB Squeeze";
            text = "Ø§Ù„Ø¨ÙˆÙ„ÙŠÙ†Ø¬Ø± Ø¶ÙŠÙ‚ â†’ Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ù†ÙØ¬Ø§Ø± Ø­Ø±ÙƒØ© Ù‚Ø±ÙŠØ¨ØŒ Ø­Ø¶Ù‘Ø± Ø®Ø·Ø© Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬.";
            strength = "neutral";
          }
        }

        return {
          indicatorsLast: last,
          pattern,
          modeInfo,
          signal,
          text,
          strength
        };
      }

      async function updateBarsAndChart(){
        btnBars.disabled = true;
        chartMsg.textContent = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† Ø§Ù„Ù€ Workerâ€¦";
        try{
          const tf   = tfSelect.value || "1m";
          const limit= Math.max(100, Math.min(5000, parseInt(limitInput.value || "800", 10)));
          const path = `/bars?tf=${encodeURIComponent(tf)}&limit=${limit}`;
          const j = await fetchJSON(path);
          if(!Array.isArray(j) || !j.length){
            ensureChart();
            candleSeries.setData([]);
            chartMsg.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù…ÙˆØ¹ Ù…Ø³ØªÙ„Ù…Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.";
            return;
          }

          const bars = j
            .map(b => ({
              time: Math.floor((Number(b.t) || 0) / 1000),
              open: Number(b.o),
              high: Number(b.h),
              low:  Number(b.l),
              close:Number(b.c),
              volume:Number(b.v || 0)
            }))
            .filter(b =>
              Number.isFinite(b.time) &&
              Number.isFinite(b.open) &&
              Number.isFinite(b.high) &&
              Number.isFinite(b.low) &&
              Number.isFinite(b.close)
            );

          if(!bars.length){
            ensureChart();
            candleSeries.setData([]);
            chartMsg.textContent = "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„Ø±Ø³Ù….";
            return;
          }

          ensureChart();
          candleSeries.setData(bars);
          chart.timeScale().fitContent();
          chartMsg.textContent = "";

          // Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª + Ø§Ù„Ù†ØµÙŠØ­Ø© + Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
          const analysis = buildSignals(bars);
          if(analysis){
            const last = analysis.indicatorsLast;
            if(last.emaFast != null) emaFastSpan.textContent = last.emaFast.toFixed(2);
            if(last.emaSlow != null) emaSlowSpan.textContent = last.emaSlow.toFixed(2);
            if(last.rsi != null)     rsiSpan.textContent     = last.rsi.toFixed(1);
            if(last.macd != null)    macdSpan.textContent    = last.macd.toFixed(3);
            if(last.stoch != null)   stochSpan.textContent   = last.stoch.toFixed(1);
            if(last.atr != null)     atrSpan.textContent     = last.atr.toFixed(2);
            if(last.bb && last.bb.width != null){
              bbSpan.textContent = (100 * last.bb.width / bars[bars.length-1].close).toFixed(2) + "%";
            }

            // Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚
            marketModeBadge.textContent = "Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚: " + (analysis.modeInfo.mode || "â€”");

            // Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
            if(analysis.signal){
              signalBadge.textContent = "Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø©: " + analysis.signal;
              adviceText.textContent  = analysis.text;
              // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ø¥Ø´Ø§Ø±Ø§Ø© Ù‚ÙˆÙŠØ© Ø£Ùˆ ÙˆØ§Ø¶Ø­Ø©
              if(["BUY STRONG","SELL STRONG","BUY TREND","SELL TREND"].includes(analysis.signal)){
                playAlertSound();
              }
            }else{
              signalBadge.textContent = "Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø©: â€”";
              // Ù…Ø§ Ù†ØºÙŠØ± Ø§Ù„Ù†ØµÙŠØ­Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ø¥Ø´Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©
            }

          } else {
            adviceText.textContent = "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª.";
          }

          touchTime();
          workerDot.classList.add("ok");
        }catch(e){
          console.error("bars error", e);
          ensureChart();
          chartMsg.textContent = "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù€ Worker Ùˆ /bars.";
          workerDot.classList.remove("ok");
          workerStatus.textContent = "ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† Ø§Ù„Ù€ Worker";
        }finally{
          btnBars.disabled = false;
        }
      }

      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©
      if(!workerUrlInput.value.trim()){
        workerUrlInput.value = DEFAULT_WORKER;
      }

      // Ø£Ø­Ø¯Ø§Ø«
      btnPrice.addEventListener("click", updatePrice);
      btnBars.addEventListener("click", updateBarsAndChart);

      // Auto load & auto refresh
      pingWorker();
      updatePrice();
      updateBarsAndChart();
      setInterval(() => {
        updatePrice();
        updateBarsAndChart();
      }, 60_000);

    })();
  </script>
</body>
</html>
